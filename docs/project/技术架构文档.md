# Claude-Mem 技术架构文档

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 架构概览

### 1.1 系统定位

Claude-Mem 是一个 **Claude Code 插件**，通过 Hook 机制嵌入 Claude Code 的工作流，实现跨会话记忆的自动捕获、压缩、存储和检索。

### 1.2 高层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        Claude Code                          │
│                    (宿主应用程序)                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐  ┌──────────────┐  ┌───────────┐  ┌────────┐ │
│  │ Session  │→│UserPrompt    │→│PostToolUse │→│  Stop   │ │
│  │ Start    │  │Submit        │  │            │  │         │ │
│  └────┬─────┘  └──────┬───────┘  └─────┬──────┘  └────┬────┘ │
│       │               │               │              │      │
└───────┼───────────────┼───────────────┼──────────────┼──────┘
        │  stdin/stdout  │               │              │
        ▼               ▼               ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Hook Scripts Layer                        │
│              (plugin/scripts/*.cjs)                          │
│                                                             │
│  ┌────────────────┐  ┌──────────────┐  ┌────────────────┐  │
│  │ context handler │  │ session-init │  │ observation    │  │
│  │ (上下文注入)     │  │ (会话初始化)  │  │ (观察记录)     │  │
│  └───────┬─────────┘  └──────┬───────┘  └───────┬────────┘  │
│          │                   │                   │           │
│          │    HTTP API       │                   │           │
│          ▼                   ▼                   ▼           │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Worker Service (Express)                    ││
│  │                  Port 37777                              ││
│  │                                                         ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────┐ ││
│  │  │ Session  │ │ Search   │ │ Context  │ │ Settings  │ ││
│  │  │ Manager  │ │ Manager  │ │ Builder  │ │ Manager   │ ││
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └───────────┘ ││
│  │       │            │            │                       ││
│  │  ┌────▼────────────▼────────────▼────────────────────┐  ││
│  │  │            Data Access Layer                       │  ││
│  │  │  ┌──────────────┐    ┌──────────────────┐         │  ││
│  │  │  │   SQLite DB   │    │   ChromaDB        │         │  ││
│  │  │  │ (SessionStore)│    │  (ChromaSync)     │         │  ││
│  │  │  └──────────────┘    └──────────────────┘         │  ││
│  │  └───────────────────────────────────────────────────┘  ││
│  │                                                         ││
│  │  ┌──────────────────────────────────────────────┐       ││
│  │  │         AI Agent Layer                        │       ││
│  │  │  ┌─────────┐ ┌─────────┐ ┌──────────────┐   │       ││
│  │  │  │SDK Agent│ │ Gemini  │ │ OpenRouter   │   │       ││
│  │  │  │(默认)   │ │ Agent   │ │ Agent        │   │       ││
│  │  │  └─────────┘ └─────────┘ └──────────────┘   │       ││
│  │  └──────────────────────────────────────────────┘       ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Viewer UI (React SPA)                       ││
│  │                http://localhost:37777                     ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 1.3 技术栈一览

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 运行时 | Bun 1.1.14+ | Worker 服务运行时（性能优势） |
| 语言 | TypeScript (ES2022) | 全栈类型安全 |
| 构建 | ESBuild | 高速编译 TS→CJS/ESM |
| HTTP | Express 4.x | Worker API 服务器 |
| 数据库 | SQLite3 (bun:sqlite) | 本地持久化，WAL 模式 |
| 向量数据库 | ChromaDB (MCP) | 语义搜索（Mac/Linux） |
| AI SDK | @anthropic-ai/claude-agent-sdk | 观察压缩和摘要生成 |
| 前端 | React 18 | Viewer UI |
| 协议 | MCP (Model Context Protocol) | 工具注册和通信 |
| 进程管理 | Node.js child_process | 进程 fork/spawn |

---

## 2. 核心架构模式

### 2.1 Hook-Driven 事件驱动架构

```
设计原则：
  - 所有数据捕获通过 Claude Code 生命周期钩子触发
  - 钩子脚本轻量（< 500ms 响应），重活交给 Worker
  - 错误不阻塞宿主工作流（exit 0 策略）

Hook 流转：
  Setup → SessionStart → UserPromptSubmit → PostToolUse(N次) → Stop
```

### 2.2 两阶段初始化

```
第一阶段（同步，< 2秒）：
  ├─ Express 服务器监听端口
  ├─ 写入 PID 文件
  └─ 返回就绪信号

第二阶段（异步，< 30秒）：
  ├─ 初始化 SQLite 数据库
  ├─ 运行迁移脚本
  ├─ 初始化 ChromaSync
  ├─ 启动孤儿进程清理器
  └─ 恢复待处理消息队列
```

### 2.3 策略模式（搜索）

```
SearchOrchestrator
  ├─ ChromaSearchStrategy   (向量语义搜索)
  ├─ SQLiteSearchStrategy   (SQL 过滤搜索)
  └─ HybridSearchStrategy   (混合搜索)

决策逻辑：
  if (无查询文本) → SQLiteSearchStrategy
  if (有查询文本 && Chroma可用) → ChromaSearchStrategy
  if (有查询文本 && 无Chroma) → SQLite FTS5
```

### 2.4 Agent 抽象层

```
接口契约：
  getActiveAgent(): SDKAgent | GeminiAgent | OpenRouterAgent

选择优先级：
  1. OpenRouter（如果选中且可用）
  2. Gemini（如果选中且可用）
  3. Claude SDK（默认）

回退机制：
  SDK失败 → Gemini → OpenRouter → 标记消息为 abandoned
```

### 2.5 消息队列模式

```
Hook → pending_messages(status=pending) → Worker 轮询处理
                                           ├─ status=processing
                                           ├─ AI Agent 压缩
                                           ├─ status=completed
                                           └─ 失败 → status=failed → 重试/abandoned
```

---

## 3. 模块架构

### 3.1 模块依赖图

```
┌─────────────────────────────────────────────────┐
│                   CLI Layer                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │ handlers │  │ adapters │  │ stdin-reader │  │
│  └────┬─────┘  └────┬─────┘  └──────┬───────┘  │
└───────┼──────────────┼───────────────┼──────────┘
        │              │               │
        ▼              ▼               ▼
┌─────────────────────────────────────────────────┐
│                Service Layer                     │
│  ┌──────────────┐  ┌────────────┐               │
│  │WorkerService │  │ Context    │               │
│  │(Orchestrator)│  │ Builder    │               │
│  └──────┬───────┘  └─────┬──────┘               │
│         │                │                       │
│  ┌──────▼───────────────▼──────────────────┐    │
│  │         Manager Layer                    │    │
│  │  ┌────────────┐  ┌──────────────┐       │    │
│  │  │ Session    │  │   Search     │       │    │
│  │  │ Manager    │  │   Manager    │       │    │
│  │  └─────┬──────┘  └──────┬───────┘       │    │
│  │        │                │                │    │
│  │  ┌─────▼──────┐  ┌─────▼──────────┐    │    │
│  │  │ SDKAgent   │  │SearchStrategy  │    │    │
│  │  │ Gemini     │  │  ├ Chroma      │    │    │
│  │  │ OpenRouter │  │  ├ SQLite      │    │    │
│  │  └────────────┘  │  └ Hybrid      │    │    │
│  │                   └────────────────┘    │    │
│  └─────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
        │                │
        ▼                ▼
┌─────────────────────────────────────────────────┐
│              Data Access Layer                   │
│  ┌──────────────┐       ┌──────────────┐        │
│  │ SessionStore │       │  ChromaSync  │        │
│  │ Observations │       │  (MCP Client)│        │
│  │ Sessions     │       └──────────────┘        │
│  │ Summaries    │                                │
│  │ Prompts      │                                │
│  └──────────────┘                                │
└─────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────┐
│            Infrastructure Layer                  │
│  ┌──────────────┐  ┌──────────┐  ┌───────────┐ │
│  │ProcessManager│  │ Health   │  │ Graceful  │ │
│  │              │  │ Monitor  │  │ Shutdown  │ │
│  └──────────────┘  └──────────┘  └───────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.2 核心模块职责

| 模块 | 路径 | 职责 | 设计模式 |
|------|------|------|---------|
| WorkerService | `src/services/worker-service.ts` | 系统编排器，管理所有子服务生命周期 | Orchestrator |
| SessionManager | `src/services/worker/SessionManager.ts` | 会话创建、恢复、完成 | State Machine |
| SearchManager | `src/services/worker/SearchManager.ts` | 搜索策略选择和结果编排 | Strategy |
| SDKAgent | `src/services/worker/SDKAgent.ts` | Claude Agent SDK 交互 | Observer |
| SessionStore | `src/services/sqlite/SessionStore.ts` | SQLite CRUD 操作 | Repository |
| ChromaSync | `src/services/sync/ChromaSync.ts` | 向量数据库同步 | Sync Gateway |
| ContextBuilder | `src/services/context/ContextBuilder.ts` | 上下文组装和格式化 | Builder |
| ProcessManager | `src/services/infrastructure/ProcessManager.ts` | 进程生命周期管理 | Lifecycle |

---

## 4. 数据架构

### 4.1 存储架构

```
本地存储 (~/.claude-mem/)
├── claude-mem.db          # SQLite 主数据库
├── claude-mem.db-wal      # WAL 日志
├── claude-mem.db-shm      # 共享内存
├── settings.json          # 用户配置
├── chroma/                # ChromaDB 数据目录
├── logs/                  # 日志文件
└── worker.pid             # PID 文件
```

### 4.2 数据流向

```
输入数据流：
  Claude Code → Hook(stdin) → Tag Stripping → Worker API → SQLite + Chroma

输出数据流：
  Claude Code ← Hook(stdout) ← Context Builder ← Worker API ← SQLite

搜索数据流：
  用户查询 → mem-search Skill → Worker API → Search Strategy → 结果格式化
```

---

## 5. 通信架构

### 5.1 进程间通信

```
Claude Code ←─ stdin/stdout ─→ Hook Script (Node.js)
                                    │
                                    │ HTTP (localhost:37777)
                                    ▼
                              Worker Service (Bun)
                                    │
                                    │ MCP Protocol
                                    ▼
                              ChromaDB Server
```

### 5.2 API 架构

| 路由前缀 | 路由模块 | 职责 |
|----------|---------|------|
| `/api/search` | SearchRoutes | 搜索和时间线查询 |
| `/api/session` | SessionRoutes | 会话管理 |
| `/api/settings` | SettingsRoutes | 配置读写 |
| `/api/data` | DataRoutes | 数据导入导出 |
| `/api/memory` | MemoryRoutes | 手动记忆存储 |
| `/api/logs` | LogsRoutes | 日志查询 |
| `/` | ViewerRoutes | UI 静态资源 |
| `/stream` | SSE | 实时事件推送 |

### 5.3 实时通信（SSE）

```
Browser ←─── SSE ───── Worker Service
                          │
                          ├─ initial_load (首次连接)
                          ├─ new_observation (新观察)
                          ├─ new_summary (新摘要)
                          ├─ new_prompt (新提示)
                          └─ processing_status (处理状态)
```

---

## 6. 安全架构

### 6.1 隐私保护

```
用户输入
  │
  ▼
┌─────────────────────────────┐
│     Tag Stripping Layer      │
│  ┌─────────────────────────┐│
│  │ <private>...</private>   ││  ← 用户手动标记
│  │ <claude-mem-context>     ││  ← 系统自动标记
│  │    ...</claude-mem-ctx>  ││
│  └─────────────────────────┘│
│  ReDoS 防护：MAX_TAG=100    │
└──────────────┬──────────────┘
               │ 剥离后的干净数据
               ▼
         Worker / Database
```

### 6.2 网络安全

- Worker 仅监听 `127.0.0.1:37777`（不对外暴露）
- 无远程数据传输
- 无身份验证（本地信任模型）

### 6.3 进程安全

- PID 文件锁定防止多实例
- 孤儿进程自动清理（5 分钟扫描周期）
- 优雅关闭（SIGTERM/SIGINT 处理）

---

## 7. 部署架构

### 7.1 安装路径

```
开发仓库 (源码)
  D:/GitHub/claude-mem/
  ├── src/              # 源代码
  └── plugin/           # 构建产物

已安装插件 (运行时)
  ~/.claude/plugins/marketplaces/thedotmack/
  └── (plugin/ 内容的副本)

数据目录 (用户数据)
  ~/.claude-mem/
  ├── claude-mem.db
  ├── settings.json
  └── chroma/
```

### 7.2 构建流水线

```
TypeScript Source
     │
     │ ESBuild (build-hooks.js)
     ▼
┌────────────────────────────────┐
│ plugin/scripts/                │
│  ├── worker-service.cjs        │  ← 主 Worker（~1.8MB）
│  ├── mcp-server.cjs            │  ← MCP 服务器
│  └── context-generator.cjs     │  ← 上下文生成器
└────────────────────────────────┘

React TSX Source
     │
     │ ESBuild (build-viewer.js)
     ▼
┌────────────────────────────────┐
│ plugin/ui/                     │
│  ├── viewer-bundle.js          │  ← React SPA Bundle
│  └── viewer.html               │  ← HTML 容器
└────────────────────────────────┘

     │
     │ sync-to-marketplace.js
     ▼
~/.claude/plugins/marketplaces/thedotmack/
```

---

## 8. 性能架构

### 8.1 Token 优化

```
三层搜索工作流（10 倍 Token 节省）：

第 1 层：搜索索引     ~50-100 tokens/结果
  └─ 返回 ID、标题、时间戳

第 2 层：时间线上下文   ~200-300 tokens
  └─ 返回锚点附近的时间线

第 3 层：批量获取详情   ~500-1000 tokens/观察
  └─ 仅获取用户选择的观察详情
```

### 8.2 数据库优化

```
SQLite PRAGMA 配置：
  journal_mode = WAL        # 并发读写
  mmap_size = 268435456     # 内存映射 256MB
  cache_size = -64000       # 64MB 缓存
  foreign_keys = ON         # 外键约束
  synchronous = NORMAL      # 平衡安全与性能
```

### 8.3 UI 性能

```
优化策略：
  ├─ SSE 增量更新（避免轮询）
  ├─ IntersectionObserver 懒加载（无限滚动）
  ├─ React.memo 防止不必要重渲染
  ├─ useMemo 缓存数据合并和排序
  └─ IIFE Bundle 减少 HTTP 请求
```

---

## 9. 可扩展性设计

### 9.1 插件扩展点

| 扩展点 | 机制 | 示例 |
|--------|------|------|
| AI Agent | 接口抽象 | 新增 AI 提供者 |
| 搜索策略 | Strategy 模式 | 新增搜索算法 |
| IDE 适配 | Adapter 模式 | 新增 IDE 支持 |
| 输出格式 | Formatter 接口 | 新增输出格式 |
| 数据库迁移 | 版本化迁移 | Schema 演进 |
| 运行模式 | JSON 配置 | 新增语言/风格 |

### 9.2 Pro 功能边界

```
开源核心（本仓库）：
  ├─ 所有 Worker API 端点完整可用
  ├─ 开源 Viewer UI 无功能限制
  └─ Pro 集成点最小化（设置 + License 验证）

Pro 扩展（外部）：
  ├─ 增强 UI（Memory Stream）
  ├─ 连接相同的 localhost:37777 端点
  └─ License 验证门控，不修改核心端点
```

---

## 10. 技术决策记录

| 决策 | 选项 | 选择 | 原因 |
|------|------|------|------|
| 运行时 | Node.js / Bun | **Bun** | SQLite 原生绑定、启动速度快 |
| 数据库 | PostgreSQL / SQLite | **SQLite** | 零配置、本地优先、无需服务器 |
| 构建工具 | Webpack / ESBuild | **ESBuild** | 编译速度快（毫秒级） |
| 向量数据库 | Pinecone / Chroma | **ChromaDB** | 本地运行、MCP 原生支持 |
| 前端框架 | Vue / React | **React** | 生态丰富、SPA 单文件部署 |
| AI 压缩 | 直接存储 / Agent压缩 | **Agent 压缩** | 结构化输出、Token 经济 |
| 进程模型 | 嵌入式 / 独立 Worker | **独立 Worker** | 不阻塞 Hook 响应、独立生命周期 |
| Windows Chroma | 启用 / 禁用 | **禁用** | MCP SDK 产生控制台弹窗 |
