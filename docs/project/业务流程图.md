# Claude-Mem 业务流程图

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 核心业务流程总览

```
┌──────────────────────────────────────────────────────────────────────┐
│                     Claude-Mem 核心业务流程                          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐      │
│  │  记忆    │     │  记忆    │     │  记忆    │     │  记忆    │      │
│  │  捕获    │────▶│  存储    │────▶│  检索    │────▶│  注入    │      │
│  └─────────┘     └─────────┘     └─────────┘     └─────────┘      │
│       │                │               │               │            │
│       ▼                ▼               ▼               ▼            │
│  工具调用观察      SQLite +         语义搜索        新会话上下文     │
│  会话摘要        ChromaDB           过滤检索        时间线注入       │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 2. 会话生命周期流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    会话生命周期流程                              │
└─────────────────────────────────────────────────────────────────┘

用户启动 Claude Code
        │
        ▼
┌───────────────┐
│ SessionStart   │
│ (Setup 钩子)   │
├───────────────┤
│ 1. 检查 Worker │◄──── Worker 未运行？
│    是否运行    │         │
│ 2. 启动 Worker │         ▼
│ 3. 等待就绪   │    fork Worker 进程
│               │    监听 37777 端口
│               │    加载数据库
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 注入上下文     │
├───────────────┤
│ 1. 查询最近    │
│    50条观察   │
│ 2. 查询最后   │
│    会话摘要   │
│ 3. 构建时间线 │
│ 4. 格式化输出 │
│ 5. 注入到会话 │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 用户输入提示   │
│(UserPrompt     │
│  Submit)       │
├───────────────┤
│ 1. 创建会话   │
│    记录       │
│ 2. 记录用户   │
│    输入       │
│ 3. 设置项目   │
│    名称       │
└───────┬───────┘
        │
        ▼
┌───────────────────────────┐
│ Claude Code 工作循环       │ ◄─── 重复多次
├───────────────────────────┤
│                           │
│  用户提示 → AI 思考       │
│      │                    │
│      ▼                    │
│  ┌──────────────┐        │
│  │ 工具调用      │        │
│  │ (Bash/Read/   │        │
│  │  Write/Edit)  │        │
│  └──────┬───────┘        │
│         │                 │
│         ▼                 │
│  ┌──────────────┐        │
│  │ PostToolUse   │        │
│  │ 观察记录      │        │
│  ├──────────────┤        │
│  │ 1. 捕获工具  │        │
│  │    输入输出  │        │
│  │ 2. 标签剥离  │        │
│  │ 3. 异步存储  │        │
│  │ 4. AI 压缩   │        │
│  │ 5. Chroma    │        │
│  │    同步      │        │
│  └──────────────┘        │
│                           │
└──────────┬────────────────┘
           │
           ▼ （用户结束会话）
┌───────────────┐
│ Stop 钩子      │
├───────────────┤
│ 1. 生成会话   │
│    摘要       │
│ 2. 标记会话   │
│    完成       │
│ 3. 清理资源   │
└───────────────┘
```

---

## 3. 记忆搜索流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    记忆搜索三层工作流                            │
└─────────────────────────────────────────────────────────────────┘

用户提问："之前是怎么解决认证问题的？"
        │
        ▼
┌───────────────────────────────────┐
│  mem-search 技能自动触发           │
│  (Claude Code 识别历史查询意图)    │
└───────────────┬───────────────────┘
                │
    ┌───────────▼──────────┐
    │ 第 1 层：搜索索引     │  ~50-100 tokens/结果
    ├──────────────────────┤
    │ search(              │
    │   query="认证问题",   │
    │   limit=20,          │
    │   project="my-app"   │
    │ )                    │
    ├──────────────────────┤
    │ 返回：               │
    │ ┌──────────────────┐ │
    │ │ ID │ 标题  │ 时间 ││
    │ │ 42 │ 认证  │ 2/5  ││
    │ │ 38 │ JWT   │ 2/3  ││
    │ │ 35 │ 登录  │ 2/1  ││
    │ └──────────────────┘ │
    └──────────┬───────────┘
               │
    ┌──────────▼───────────┐
    │ 第 2 层：时间线上下文  │  ~200-300 tokens
    ├──────────────────────┤
    │ timeline(            │
    │   anchor=42,         │
    │   depth_before=3,    │
    │   depth_after=3      │
    │ )                    │
    ├──────────────────────┤
    │ 返回：               │
    │ ┌──────────────────┐ │
    │ │ 时间线            ││
    │ │ 39: 读取配置文件  ││
    │ │ 40: 修改中间件    ││
    │ │ 41: 调试token     ││
    │ │►42: 解决认证问题  ││ ← 锚点
    │ │ 43: 添加测试      ││
    │ │ 44: 更新文档      ││
    │ └──────────────────┘ │
    └──────────┬───────────┘
               │
    ┌──────────▼───────────┐
    │ 第 3 层：获取详情     │  ~500-1000 tokens/观察
    ├──────────────────────┤
    │ get_observations(    │
    │   ids=[42, 41, 40]   │
    │ )                    │
    ├──────────────────────┤
    │ 返回完整观察：       │
    │ ┌──────────────────┐ │
    │ │ #42              ││
    │ │ 标题: 解决JWT认证││
    │ │ 叙述: 发现token  ││
    │ │   过期时间配置... ││
    │ │ 事实:            ││
    │ │  - JWT过期=24h   ││
    │ │  - 刷新token...  ││
    │ │ 文件:            ││
    │ │  - auth.ts       ││
    │ │  - middleware.ts  ││
    │ └──────────────────┘ │
    └──────────┬───────────┘
               │
               ▼
┌──────────────────────────────┐
│ Claude Code 使用检索到的记忆  │
│ 回答用户问题                  │
└──────────────────────────────┘
```

---

## 4. 观察数据处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    观察数据处理流程                              │
└─────────────────────────────────────────────────────────────────┘

Claude Code 执行工具调用
        │
        ▼
┌───────────────────┐
│ PostToolUse Hook   │
│ 触发               │
├───────────────────┤
│ stdin 接收 JSON:   │
│ {                  │
│   tool_name,       │
│   tool_input,      │
│   tool_output,     │
│   session_id       │
│ }                  │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐     ┌─────────────────────────┐
│ 标签剥离处理       │     │ 包含 <private> 标签？    │
├───────────────────┤     ├─────────────────────────┤
│ stripMemoryTags   │────▶│ 是 → 移除标签内的内容   │
│ FromJson()        │     │ 否 → 保持原样           │
└────────┬──────────┘     └─────────────────────────┘
         │
         ▼
┌───────────────────┐
│ HTTP POST 到       │
│ Worker API         │
│ /api/session/      │
│   observation      │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 创建 pending      │
│ message           │
│ (status=pending)  │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐         ┌─────────────────────────┐
│ AI Agent 处理      │         │ 选择 Agent：             │
│ (异步后台)         │────────▶│ 1. Claude SDK (默认)    │
├───────────────────┤         │ 2. Gemini (备选)        │
│ status=processing │         │ 3. OpenRouter (备选)    │
└────────┬──────────┘         └─────────────────────────┘
         │
         ▼
┌───────────────────┐
│ AI 提取结构化数据  │
├───────────────────┤
│ ┌───────────────┐ │
│ │ title         │ │ → 标题
│ │ narrative     │ │ → 叙述
│ │ facts[]       │ │ → 事实列表
│ │ concepts[]    │ │ → 概念列表
│ │ files_read[]  │ │ → 读取的文件
│ │ files_modified│ │ → 修改的文件
│ │ type          │ │ → 类型(discovery/bugfix/...)
│ └───────────────┘ │
└────────┬──────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────────┐
│ SQLite │ │ ChromaDB   │
│ 存储   │ │ 向量同步   │
│        │ │ (异步)     │
├────────┤ ├────────────┤
│INSERT  │ │ 分离文档：  │
│observa-│ │ - narrative│
│tions   │ │ - text     │
│        │ │ - facts    │
└────────┘ └────────────┘
         │
         ▼
┌───────────────────┐
│ 更新消息状态       │
│ status=completed  │
└───────────────────┘
```

---

## 5. Worker 服务启动流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Worker 服务启动流程                           │
└─────────────────────────────────────────────────────────────────┘

SessionStart Hook 触发
        │
        ▼
┌───────────────────┐     ┌──────────┐
│ 检查 PID 文件      │────▶│ Worker   │
│ 存在且进程存活？   │ 是  │ 已运行   │──── 跳过启动
└────────┬──────────┘     └──────────┘
         │ 否
         ▼
┌───────────────────┐
│ 第一阶段           │  < 2 秒
│ (同步启动)         │
├───────────────────┤
│ 1. fork Worker    │
│    子进程          │
│ 2. Express 监听   │
│    37777 端口     │
│ 3. 写入 PID 文件  │
│ 4. 返回就绪信号   │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 第二阶段           │  < 30 秒
│ (异步初始化)       │
├───────────────────┤
│ 1. 初始化 SQLite  │
│    数据库          │
│ 2. 运行数据库     │
│    迁移           │
│ 3. 重置 stale     │
│    消息           │
│ 4. 初始化         │
│    ChromaSync     │
│ 5. 启动孤儿       │
│    进程清理器     │
│ 6. 恢复待处理     │
│    消息队列       │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ Worker 就绪        │
│ 等待 API 请求      │
└───────────────────┘
```

---

## 6. 上下文注入流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    上下文注入流程                                │
└─────────────────────────────────────────────────────────────────┘

新会话 SessionStart
        │
        ▼
┌───────────────────┐
│ ContextConfigLoader│
│ 加载配置           │
├───────────────────┤
│ · 观察数量: 50     │
│ · 完整详情: 5      │
│ · 会话数: 10       │
│ · 类型过滤         │
│ · 概念过滤         │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ ObservationCompiler│
│ 编译观察数据       │
├───────────────────┤
│ 1. 查询最近 50 条  │
│    观察记录        │
│ 2. 应用类型过滤    │
│ 3. 应用概念过滤    │
│ 4. 按时间排序      │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ TokenCalculator    │
│ 计算 Token 预算    │
├───────────────────┤
│ · 当前 Token 数    │
│ · 预算上限         │
│ · 截断策略         │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 渲染上下文段落     │
├───────────────────┤
│                   │
│ HeaderRenderer    │ → 📋 项目: my-app | v9.1.1
│        │          │
│        ▼          │
│ TimelineRenderer  │ → 📅 最近观察时间线
│        │          │     2/8 10:00 - 修复登录 Bug
│        │          │     2/8 09:30 - 添加单元测试
│        ▼          │     2/7 16:00 - 重构认证模块
│ SummaryRenderer   │ → 📝 上次会话摘要
│        │          │     请求: 优化数据库性能
│        │          │     完成: 添加索引和缓存
│        ▼          │
│ FooterRenderer    │ → 💡 使用提示
│                   │     搜索: mem-search 技能
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 注入到 Claude Code │
│ (hookSpecific      │
│  Output)           │
└───────────────────┘
```

---

## 7. 数据导入导出流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据导入/导出流程                             │
└─────────────────────────────────────────────────────────────────┘

导出：
  GET /api/data/export
        │
        ▼
  ┌───────────────────┐
  │ 查询所有数据       │
  │ · sessions         │
  │ · observations     │
  │ · summaries        │
  │ · user_prompts     │
  └────────┬──────────┘
           │
           ▼
  ┌───────────────────┐
  │ JSON 序列化        │
  │ 返回完整数据集     │
  └───────────────────┘

导入：
  POST /api/data/import
        │
        ▼
  ┌───────────────────┐
  │ 解析 JSON 数据     │
  └────────┬──────────┘
           │
           ▼
  ┌───────────────────┐
  │ 批量插入           │
  │ (事务保护)         │
  │ · bulk insert      │
  │   sessions         │
  │ · bulk insert      │
  │   observations     │
  │ · bulk insert      │
  │   summaries        │
  └────────┬──────────┘
           │
           ▼
  ┌───────────────────┐
  │ ChromaDB 回填      │
  │ (异步同步)         │
  └───────────────────┘
```

---

## 8. 设置管理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    设置管理流程                                  │
└─────────────────────────────────────────────────────────────────┘

设置加载（优先级从高到低）：

  ┌───────────────────┐
  │ 环境变量           │  ← 最高优先级
  │ process.env.*      │
  └────────┬──────────┘
           │ 未设置？
           ▼
  ┌───────────────────┐
  │ 用户配置文件       │
  │ ~/.claude-mem/     │
  │   settings.json    │
  └────────┬──────────┘
           │ 未设置？
           ▼
  ┌───────────────────┐
  │ 程序默认值         │  ← 最低优先级
  │ SettingsDefaults   │
  │ Manager.DEFAULTS   │
  └───────────────────┘

设置更新：

  用户通过 Viewer UI 修改设置
        │
        ▼
  POST /api/settings
        │
        ▼
  ┌───────────────────┐
  │ 验证设置值         │
  │ 写入 settings.json │
  │ 热重载生效         │
  └───────────────────┘
```
