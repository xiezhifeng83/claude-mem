# Claude-Mem 数据库设计文档

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 数据库概述

| 属性 | 值 |
|------|-----|
| 数据库引擎 | SQLite3（通过 bun:sqlite） |
| 存储路径 | `~/.claude-mem/claude-mem.db` |
| 日志模式 | WAL（Write-Ahead Logging） |
| 当前迁移版本 | v20 |
| 编码 | UTF-8 |

### PRAGMA 配置

```sql
PRAGMA journal_mode = WAL;
PRAGMA mmap_size = 268435456;     -- 256MB 内存映射
PRAGMA cache_size = -64000;       -- 64MB 缓存
PRAGMA foreign_keys = ON;         -- 启用外键约束
PRAGMA synchronous = NORMAL;      -- 平衡安全与性能
```

---

## 2. 实体关系图（ER Diagram）

```
┌────────────────────┐         ┌─────────────────────────┐
│    sdk_sessions     │         │      observations       │
├────────────────────┤    1:N  ├─────────────────────────┤
│ PK id              │◄────────│ FK memory_session_id    │
│    content_session │         │ PK id                   │
│    _id (UNIQUE)    │         │    project              │
│    memory_session  │         │    type                  │
│    _id (UNIQUE)    │         │    title                 │
│    project         │         │    subtitle              │
│    user_prompt     │         │    narrative             │
│    status          │         │    facts (JSON)          │
│    prompt_counter  │         │    concepts (JSON)       │
│    started_at_epoch│         │    files_read (JSON)     │
│    completed_at    │         │    files_modified (JSON) │
│    _epoch          │         │    prompt_number         │
│    worker_port     │         │    created_at_epoch      │
└────────┬───────────┘         │    discovery_tokens      │
         │                     └─────────────────────────┘
         │
         │                     ┌─────────────────────────┐
         │              1:1    │   session_summaries      │
         │◄────────────────────│ FK memory_session_id    │
         │                     │ PK id                   │
         │                     │    project              │
         │                     │    request              │
         │                     │    investigated         │
         │                     │    learned              │
         │                     │    completed            │
         │                     │    next_steps           │
         │                     │    notes                │
         │                     │    prompt_number        │
         │                     │    created_at_epoch     │
         │                     └─────────────────────────┘
         │
         │                     ┌─────────────────────────┐
         │              1:N    │   pending_messages       │
         │◄────────────────────│ FK session_db_id        │
         │                     │ PK id                   │
         │                     │    message_type         │
         │                     │    data (JSON)          │
         │                     │    status               │
         │                     │    processing_started   │
         │                     │    _at_epoch            │
         │                     │    failed_at_epoch      │
         │                     └─────────────────────────┘
         │
         │                     ┌─────────────────────────┐
         │              1:N    │    user_prompts          │
         │◄────────────────────│ FK memory_session_id    │
                               │ PK id                   │
                               │    project              │
                               │    content              │
                               │    prompt_number        │
                               │    created_at_epoch     │
                               └─────────────────────────┘

┌─────────────────────────┐
│         meta             │
├─────────────────────────┤
│ PK key                   │
│    value                 │
└─────────────────────────┘
```

---

## 3. 表结构详细说明

### 3.1 sdk_sessions（会话表）

**主表**：存储每个 Claude Code 工作会话的元数据。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 内部数据库 ID |
| `content_session_id` | TEXT | UNIQUE NOT NULL | Claude Code 会话 ID |
| `memory_session_id` | TEXT | UNIQUE | SDK Agent 会话 ID（延迟填充） |
| `project` | TEXT | NOT NULL | 项目名称（从工作目录提取） |
| `user_prompt` | TEXT | | 首次用户输入内容 |
| `started_at_epoch` | INTEGER | NOT NULL | 会话开始时间戳（秒） |
| `completed_at_epoch` | INTEGER | | 会话完成时间戳（秒） |
| `status` | TEXT | NOT NULL DEFAULT 'active' | 状态：active / completed / failed |
| `prompt_counter` | INTEGER | DEFAULT 1 | 当前提示序号计数器 |
| `worker_port` | INTEGER | | Worker 服务端口号 |

**索引**：
```sql
CREATE UNIQUE INDEX idx_sessions_content_id ON sdk_sessions(content_session_id);
CREATE UNIQUE INDEX idx_sessions_memory_id ON sdk_sessions(memory_session_id);
CREATE INDEX idx_sessions_project ON sdk_sessions(project);
CREATE INDEX idx_sessions_status ON sdk_sessions(status);
CREATE INDEX idx_sessions_started ON sdk_sessions(started_at_epoch);
```

### 3.2 observations（观察表）

**核心表**：存储从工具调用中提取的结构化观察记录。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 观察记录 ID |
| `memory_session_id` | TEXT | FK → sdk_sessions | 所属会话 |
| `project` | TEXT | NOT NULL | 项目名称 |
| `text` | TEXT | | 遗留字段：原始文本 |
| `type` | TEXT | | 类型：discovery / bugfix / feature / decision / change |
| `title` | TEXT | | 观察标题 |
| `subtitle` | TEXT | | 观察副标题 |
| `narrative` | TEXT | | 叙述内容（主要字段） |
| `facts` | TEXT | | JSON 数组：提取的事实 |
| `concepts` | TEXT | | JSON 数组：相关概念 |
| `files_read` | TEXT | | JSON 数组：读取的文件路径 |
| `files_modified` | TEXT | | JSON 数组：修改的文件路径 |
| `prompt_number` | INTEGER | | 所属提示序号 |
| `created_at_epoch` | INTEGER | NOT NULL | 创建时间戳 |
| `discovery_tokens` | INTEGER | | Token 消耗（ROI 指标） |

**索引**：
```sql
CREATE INDEX idx_obs_session ON observations(memory_session_id);
CREATE INDEX idx_obs_project ON observations(project);
CREATE INDEX idx_obs_type ON observations(type);
CREATE INDEX idx_obs_created ON observations(created_at_epoch);
```

### 3.3 session_summaries（会话摘要表）

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 摘要 ID |
| `memory_session_id` | TEXT | UNIQUE FK → sdk_sessions | 所属会话（一对一） |
| `project` | TEXT | NOT NULL | 项目名称 |
| `request` | TEXT | | 请求内容：本次会话要做什么 |
| `investigated` | TEXT | | 调查内容：探索了什么 |
| `learned` | TEXT | | 学习内容：发现了什么 |
| `completed` | TEXT | | 完成内容：做完了什么 |
| `next_steps` | TEXT | | 后续步骤：还需要做什么 |
| `notes` | TEXT | | 补充笔记 |
| `prompt_number` | INTEGER | | 所属提示序号 |
| `created_at_epoch` | INTEGER | NOT NULL | 创建时间戳 |

### 3.4 pending_messages（待处理消息表）

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 消息 ID |
| `session_db_id` | INTEGER | FK → sdk_sessions.id | 所属会话的数据库 ID |
| `message_type` | TEXT | NOT NULL | 类型：observation / summary |
| `data` | TEXT | NOT NULL | JSON 序列化的消息数据 |
| `status` | TEXT | NOT NULL DEFAULT 'pending' | 状态：pending / processing / completed / failed / abandoned |
| `processing_started_at_epoch` | INTEGER | | 开始处理时间戳 |
| `failed_at_epoch` | INTEGER | | 失败时间戳 |

**索引**：
```sql
CREATE INDEX idx_pending_status ON pending_messages(status);
CREATE INDEX idx_pending_session ON pending_messages(session_db_id);
```

### 3.5 user_prompts（用户提示表）

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 提示 ID |
| `memory_session_id` | TEXT | FK → sdk_sessions | 所属会话 |
| `project` | TEXT | NOT NULL | 项目名称 |
| `content` | TEXT | NOT NULL | 用户输入内容 |
| `prompt_number` | INTEGER | | 提示序号 |
| `created_at_epoch` | INTEGER | NOT NULL | 创建时间戳 |

### 3.6 meta（元数据表）

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `key` | TEXT | PRIMARY KEY | 元数据键名 |
| `value` | TEXT | | 元数据值 |

**用途**：存储 schema_version 等系统级元数据。

---

## 4. 数据类型枚举

### 4.1 会话状态（sdk_sessions.status）

| 值 | 说明 |
|-----|------|
| `active` | 会话进行中 |
| `completed` | 会话正常完成 |
| `failed` | 会话异常终止 |

### 4.2 观察类型（observations.type）

| 值 | 说明 |
|-----|------|
| `discovery` | 新发现 |
| `bugfix` | Bug 修复 |
| `feature` | 功能开发 |
| `decision` | 技术决策 |
| `change` | 代码变更 |

### 4.3 消息状态（pending_messages.status）

| 值 | 说明 | 转换条件 |
|-----|------|---------|
| `pending` | 等待处理 | 初始状态 |
| `processing` | 正在处理 | Worker 取出处理 |
| `completed` | 处理完成 | AI Agent 成功处理 |
| `failed` | 处理失败 | AI Agent 处理异常 |
| `abandoned` | 放弃处理 | 重试次数超限（≥3） |

---

## 5. 迁移历史

| 版本 | 变更内容 | 影响 |
|------|---------|------|
| v4 | 初始 schema：sdk_sessions、observations | 基础表结构 |
| v6 | 添加 observations.subtitle | 增强观察描述 |
| v8 | 添加 user_prompts 表 | 记录用户输入 |
| v10 | 添加 session_summaries 表 | 结构化会话摘要 |
| v12 | 添加 pending_messages 表 | 异步消息队列 |
| v14 | 添加外键约束 | 数据完整性 |
| v16 | 添加 timeline 视图 | 时间线查询优化 |
| v18 | 添加 concepts、facts 列 | 结构化元数据 |
| v20 | 添加 discovery_tokens 列 | ROI 追踪 |

---

## 6. ChromaDB 向量数据库

### 6.1 Collection 设计

| 属性 | 值 |
|------|-----|
| Collection 名称 | `claude-mem-memories` |
| 嵌入模型 | ChromaDB 默认（all-MiniLM-L6-v2） |
| 存储路径 | `~/.claude-mem/chroma/` |
| 平台支持 | macOS、Linux（Windows 禁用） |

### 6.2 文档格式

**观察文档**（每个观察生成多个文档）：

| 文档 ID | 内容 | 元数据 |
|---------|------|--------|
| `obs_{id}_narrative` | narrative 字段 | project, type, session_id, created_at |
| `obs_{id}_text` | text 字段 | project, type, session_id, created_at |
| `obs_{id}_fact_{n}` | facts[n] | project, type, session_id, created_at |

**摘要文档**（每个摘要生成多个文档）：

| 文档 ID | 内容 | 元数据 |
|---------|------|--------|
| `sum_{id}_request` | request 字段 | project, session_id, created_at |
| `sum_{id}_investigated` | investigated 字段 | project, session_id, created_at |
| `sum_{id}_learned` | learned 字段 | project, session_id, created_at |
| `sum_{id}_completed` | completed 字段 | project, session_id, created_at |
| `sum_{id}_next_steps` | next_steps 字段 | project, session_id, created_at |

**用户提示文档**：

| 文档 ID | 内容 | 元数据 |
|---------|------|--------|
| `prompt_{id}` | content 字段 | project, session_id, created_at |

### 6.3 分离策略原因

```
为什么每个实体拆分为多个文档？

原因：向量嵌入对短文本更精确

  长文本 "修复了认证Bug，涉及JWT过期配置和刷新Token逻辑，
          同时发现数据库连接池需要调整..."
    → 嵌入向量覆盖多个语义维度，搜索精度低

  拆分后：
    narrative: "修复了认证Bug"  → 精确匹配"认证"相关查询
    fact_0: "JWT过期时间=24h"   → 精确匹配"JWT"相关查询
    fact_1: "数据库连接池=50"   → 精确匹配"数据库"相关查询
```

---

## 7. 查询模式

### 7.1 高频查询

```sql
-- 获取最近 N 条观察（上下文注入）
SELECT * FROM observations
WHERE project = ?
ORDER BY created_at_epoch DESC
LIMIT ?;

-- 获取最新会话摘要
SELECT * FROM session_summaries
WHERE project = ?
ORDER BY created_at_epoch DESC
LIMIT 1;

-- 获取待处理消息
SELECT * FROM pending_messages
WHERE status = 'pending'
ORDER BY id ASC
LIMIT 10;

-- 批量获取观察详情
SELECT * FROM observations
WHERE id IN (?, ?, ?, ...);

-- 全文搜索（FTS5 降级模式）
SELECT * FROM observations
WHERE narrative LIKE '%' || ? || '%'
   OR title LIKE '%' || ? || '%'
   OR facts LIKE '%' || ? || '%'
ORDER BY created_at_epoch DESC
LIMIT ?;
```

### 7.2 事务模式

```sql
-- 观察存储事务
BEGIN;
  INSERT INTO observations (...) VALUES (...);
  UPDATE sdk_sessions
    SET prompt_counter = prompt_counter + 1
    WHERE content_session_id = ?;
  INSERT INTO pending_messages (...)
    VALUES (?, 'observation', ?, 'processing');
COMMIT;

-- 会话完成事务
BEGIN;
  UPDATE sdk_sessions
    SET status = 'completed',
        completed_at_epoch = ?
    WHERE content_session_id = ?;
  UPDATE pending_messages
    SET status = 'abandoned'
    WHERE session_db_id = ?
      AND status IN ('pending', 'processing');
COMMIT;
```
