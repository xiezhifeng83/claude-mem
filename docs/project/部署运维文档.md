# Claude-Mem 部署运维文档

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 环境要求

### 1.1 系统要求

| 组件 | 最低版本 | 推荐版本 | 说明 |
|------|---------|---------|------|
| Node.js | 18.0+ | 20.x LTS | 构建和 Hook 脚本执行 |
| Bun | 1.1.14+ | 最新 | Worker 服务运行时 |
| Python | 3.8+ | 3.11+ | ChromaDB 依赖（通过 uv） |
| uv | 最新 | 最新 | Python 包管理器（自动安装） |

### 1.2 操作系统支持

| 平台 | 支持状态 | 限制 |
|------|---------|------|
| macOS (Intel/ARM) | ✅ 完整支持 | 无 |
| Linux (x64/ARM) | ✅ 完整支持 | 无 |
| Windows 10/11 | ✅ 支持 | ChromaDB 向量搜索禁用 |

### 1.3 磁盘空间

| 组件 | 预估大小 |
|------|---------|
| 插件代码 | ~5MB |
| SQLite 数据库（每万条观察） | ~50MB |
| ChromaDB 向量数据（每万条） | ~200MB |
| 日志文件 | ~10MB |

---

## 2. 安装部署

### 2.1 作为 Claude Code 插件安装

```bash
# 通过 Claude Code 插件市场安装
claude plugins install thedotmack/claude-mem
```

插件安装后自动部署到：
```
~/.claude/plugins/marketplaces/thedotmack/
```

### 2.2 从源码构建部署

```bash
# 1. 克隆仓库
git clone https://github.com/thedotmack/claude-mem.git
cd claude-mem

# 2. 安装依赖
npm install

# 3. 构建并同步到插件目录
npm run build-and-sync
```

**build-and-sync 执行流程**：
```
1. ESBuild 编译 TypeScript → CJS
2. ESBuild 编译 React TSX → Bundle
3. 复制构建产物到 plugin/ 目录
4. 同步 plugin/ 到 ~/.claude/plugins/marketplaces/thedotmack/
5. 重启 Worker 服务
```

### 2.3 首次启动

首次启动 Claude Code 时，claude-mem 自动执行：

1. **Setup Hook** 运行 `setup.sh`
2. 检测并安装 Bun（如未安装）
3. 检测并安装 uv（如未安装）
4. 创建数据目录 `~/.claude-mem/`
5. 初始化 `settings.json`
6. 启动 Worker 服务
7. 运行数据库迁移

---

## 3. 服务管理

### 3.1 Worker 服务管理

```bash
# 启动 Worker
npm run worker:start

# 停止 Worker
npm run worker:stop

# 重启 Worker
npm run worker:restart

# 查看状态
npm run worker:status

# 查看日志
npm run worker:logs

# 实时日志
npm run worker:tail
```

### 3.2 进程管理

**PID 文件**：`~/.claude-mem/worker.pid`

```json
{
  "pid": 12345,
  "port": 37777,
  "startedAt": "2026-02-08T10:00:00Z"
}
```

**健康检查**：

```bash
# HTTP 健康检查
curl http://127.0.0.1:37777/health

# 检查进程
# Linux/Mac
ps aux | grep worker-service

# Windows
tasklist | findstr bun
```

### 3.3 自动重启机制

Worker 服务在以下场景自动重启：

| 场景 | 触发方式 |
|------|---------|
| 新会话启动 | SessionStart Hook 检测 Worker 不可用时自动启动 |
| 工具调用 | PostToolUse Hook 检测 Worker 不可用时自动启动 |
| 用户输入 | UserPromptSubmit Hook 检测 Worker 不可用时自动启动 |

---

## 4. 配置管理

### 4.1 配置文件位置

```
~/.claude-mem/settings.json
```

### 4.2 配置项一览

```json
{
  "CLAUDE_MEM_PROVIDER": "claude",
  "CLAUDE_MEM_WORKER_PORT": "37777",
  "CLAUDE_MEM_WORKER_HOST": "127.0.0.1",
  "CLAUDE_MEM_DATA_DIR": "~/.claude-mem",
  "CLAUDE_MEM_CONTEXT_OBSERVATIONS": "50",
  "CLAUDE_MEM_CONTEXT_FULL_COUNT": "5",
  "CLAUDE_MEM_CONTEXT_SESSION_COUNT": "10",
  "CLAUDE_MEM_GEMINI_API_KEY": "",
  "CLAUDE_MEM_GEMINI_MODEL": "gemini-2.5-flash-lite",
  "CLAUDE_MEM_GEMINI_RATE_LIMITING_ENABLED": "true",
  "CLAUDE_MEM_OPENROUTER_MODEL": "xiaomi/mimo-v2-flash:free"
}
```

### 4.3 环境变量覆盖

所有配置项均可通过环境变量覆盖（优先级最高）：

```bash
export CLAUDE_MEM_WORKER_PORT=38888
export CLAUDE_MEM_PROVIDER=gemini
export CLAUDE_MEM_GEMINI_API_KEY=your-key
```

### 4.4 通过 UI 管理配置

访问 `http://127.0.0.1:37777`，点击设置按钮可视化管理配置。

---

## 5. 数据管理

### 5.1 数据备份

```bash
# 备份 SQLite 数据库
cp ~/.claude-mem/claude-mem.db ~/.claude-mem/claude-mem.db.backup

# 备份完整数据目录
cp -r ~/.claude-mem ~/.claude-mem-backup-$(date +%Y%m%d)

# 通过 API 导出
curl http://127.0.0.1:37777/api/data/export > backup.json
```

### 5.2 数据恢复

```bash
# 从文件恢复
cp ~/.claude-mem/claude-mem.db.backup ~/.claude-mem/claude-mem.db

# 通过 API 导入
curl -X POST http://127.0.0.1:37777/api/data/import \
  -H "Content-Type: application/json" \
  -d @backup.json
```

### 5.3 数据清理

```bash
# 清理重复观察
npx ts-node src/bin/cleanup-duplicates.ts

# 清理失败的消息队列
npm run queue:clear
```

### 5.4 ChromaDB 重建

```bash
# 删除 Chroma 数据目录
rm -rf ~/.claude-mem/chroma/

# 重启 Worker（自动重建并回填）
npm run worker:restart
```

---

## 6. 消息队列管理

### 6.1 查看队列状态

```bash
# 查看待处理消息数量
npm run queue

# 或通过 API
curl http://127.0.0.1:37777/api/session/status
```

### 6.2 处理积压队列

```bash
# 手动触发队列处理
npm run queue:process
```

### 6.3 清理失败消息

```bash
# 清理所有 failed/abandoned 消息
npm run queue:clear
```

### 6.4 消息状态流转

```
pending → processing → completed
                    ↘ failed → pending（重试）
                             ↘ abandoned（放弃，重试≥3次）
```

---

## 7. 监控与诊断

### 7.1 日志查看

```bash
# Worker 日志
npm run worker:logs

# 实时跟踪
npm run worker:tail

# 日志文件位置
~/.claude-mem/logs/
```

### 7.2 健康检查

```bash
# 基础健康检查
curl http://127.0.0.1:37777/health

# 预期响应
{
  "status": "ok",
  "version": "9.1.1",
  "uptime": 3600,
  "database": "connected",
  "chroma": "connected"
}
```

### 7.3 常见问题诊断

#### Worker 无法启动

```bash
# 检查端口占用
# Linux/Mac
lsof -i :37777
# Windows
netstat -ano | findstr :37777

# 清理残留 PID 文件
rm ~/.claude-mem/worker.pid

# 强制重启
npm run worker:stop && npm run worker:start
```

#### 数据库锁定

```bash
# 检查 WAL 文件
ls -la ~/.claude-mem/claude-mem.db*

# 如果 WAL 文件过大，执行 checkpoint
sqlite3 ~/.claude-mem/claude-mem.db "PRAGMA wal_checkpoint(TRUNCATE);"
```

#### ChromaDB 连接失败

```bash
# 检查 Chroma 服务状态
# Chroma 通过 MCP 服务器管理，非独立进程

# 重建 Chroma 数据
rm -rf ~/.claude-mem/chroma/
npm run worker:restart
```

#### 孤儿进程清理

```bash
# Worker 内置孤儿进程清理器（5 分钟扫描周期）
# 手动检查孤儿进程
# Linux/Mac
ps aux | grep "claude-mem\|worker-service"
# Windows
tasklist | findstr "bun node"
```

---

## 8. 升级指南

### 8.1 插件升级

```bash
# 通过 Claude Code 升级
claude plugins update thedotmack/claude-mem

# 或从源码升级
cd claude-mem
git pull
npm install
npm run build-and-sync
```

### 8.2 数据库迁移

数据库迁移在 Worker 启动时**自动执行**：

```
Worker 启动 → 检查 schema_version → 执行缺失的迁移 → 更新版本号
```

**迁移安全保障**：
- 每个迁移包裹在事务中
- 失败自动回滚
- 幂等执行（不会重复应用）

### 8.3 回滚

```bash
# 1. 恢复备份的数据库
cp ~/.claude-mem/claude-mem.db.backup ~/.claude-mem/claude-mem.db

# 2. 切换到旧版本代码
git checkout v9.0.0

# 3. 重新构建
npm run build-and-sync
```

---

## 9. 安全建议

### 9.1 数据安全

| 建议 | 说明 |
|------|------|
| 定期备份 | 每周备份 `~/.claude-mem/` 目录 |
| 使用 `<private>` 标签 | 敏感信息用 `<private>` 标签包裹 |
| 不暴露端口 | Worker 仅监听 127.0.0.1，不要改为 0.0.0.0 |
| 文件权限 | 确保 `~/.claude-mem/` 目录仅当前用户可访问 |

### 9.2 API Key 安全

```bash
# 不要在环境变量中明文存储 API Key
# 推荐使用 settings.json（权限 600）
chmod 600 ~/.claude-mem/settings.json
```

---

## 10. 性能调优

### 10.1 数据库优化

```bash
# 手动执行 VACUUM
sqlite3 ~/.claude-mem/claude-mem.db "VACUUM;"

# 优化 WAL 大小
sqlite3 ~/.claude-mem/claude-mem.db "PRAGMA wal_checkpoint(TRUNCATE);"

# 分析查询性能
sqlite3 ~/.claude-mem/claude-mem.db "PRAGMA optimize;"
```

### 10.2 上下文调优

| 配置项 | 调优建议 |
|--------|---------|
| `CONTEXT_OBSERVATIONS` | 项目大时减少（如 30），节省 Token |
| `CONTEXT_FULL_COUNT` | 减少到 3 可显著节省 Token |
| `CONTEXT_SESSION_COUNT` | 5-10 为最佳平衡点 |

### 10.3 搜索性能

| 优化 | 说明 |
|------|------|
| 启用 ChromaDB | 语义搜索比 FTS5 更准确 |
| 限制搜索范围 | 使用 project 和 date 过滤缩小范围 |
| 合理设置 limit | 默认 20 已经足够，不要设置过大 |

---

## 11. 目录结构参考

```
~/.claude-mem/                    # 数据根目录
├── claude-mem.db                 # SQLite 主数据库
├── claude-mem.db-wal             # WAL 日志
├── claude-mem.db-shm             # 共享内存
├── settings.json                 # 用户配置
├── worker.pid                    # Worker PID 文件
├── chroma/                       # ChromaDB 数据
└── logs/                         # 日志文件

~/.claude/plugins/marketplaces/thedotmack/  # 插件安装目录
├── hooks/                        # Hook 配置
│   └── hooks.json
├── scripts/                      # 可执行脚本
│   ├── worker-service.cjs
│   ├── mcp-server.cjs
│   └── ...
├── skills/                       # 技能定义
│   └── mem-search/
├── modes/                        # 运行模式
├── commands/                     # 命令定义
└── ui/                           # UI 资源
    └── viewer.html
```
