# Claude-Mem 业务程序流程图

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 主程序入口流程

```
┌────────────────────────────────────────────────────────────────────┐
│                      主程序入口流程                                │
└────────────────────────────────────────────────────────────────────┘

Claude Code 触发 Hook
        │
        ▼
┌─────────────────────────────┐
│ hook-command.ts              │
│ parseCommand(argv)           │
├─────────────────────────────┤
│ argv[2] = IDE 类型           │
│   └─ "claude-code" | "cursor"│
│ argv[3] = 事件类型           │
│   └─ "context" | "session-  │
│      init" | "observation"  │
│      | "summarize" |        │
│      "session-complete"     │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ 选择 IDE 适配器              │
├─────────────────────────────┤
│ switch (ideType) {          │
│   case "claude-code":       │
│     adapter = ClaudeCode    │
│   case "cursor":            │
│     adapter = Cursor        │
│   default:                  │
│     adapter = Raw           │
│ }                           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ 选择事件处理器               │
├─────────────────────────────┤
│ switch (eventType) {        │
│   case "context":           │
│     → contextHandler()      │
│   case "session-init":      │
│     → sessionInitHandler()  │
│   case "observation":       │
│     → observationHandler()  │
│   case "summarize":         │
│     → summarizeHandler()    │
│   case "session-complete":  │
│     → sessionComplete       │
│       Handler()             │
│ }                           │
└─────────────────────────────┘
```

---

## 2. Worker Service 启动程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    Worker Service 启动程序流程                     │
└────────────────────────────────────────────────────────────────────┘

worker-service.ts :: main()
        │
        ▼
┌───────────────────────────────────────┐
│ parseArgs(process.argv)               │
│   command = "start" | "stop" | "hook" │
└──────────┬────────────────────────────┘
           │
     ┌─────┴─────┬──────────────┐
     ▼           ▼              ▼
 "start"      "stop"         "hook"
     │           │              │
     ▼           ▼              ▼
┌─────────┐ ┌─────────┐  ┌──────────────┐
│ start() │ │ stop()  │  │ hookHandler()│
└────┬────┘ └────┬────┘  └──────┬───────┘
     │           │              │
     ▼           ▼              ▼
                              (见 Hook 流程)

start() 详细流程：
     │
     ▼
┌───────────────────────────────────────┐
│ 1. 读取 PID 文件                      │
│    const pidInfo = readPidFile()      │
│    if (pidInfo && isProcessAlive(pid))│
│      return "Already running"        │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 创建 Express 应用                  │
│    const app = express()              │
│    app.use(cors())                    │
│    app.use(express.json())            │
│    app.use(errorHandler)              │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 注册路由                           │
│    registerSearchRoutes(app)          │
│    registerSessionRoutes(app)         │
│    registerSettingsRoutes(app)        │
│    registerDataRoutes(app)            │
│    registerMemoryRoutes(app)          │
│    registerLogsRoutes(app)            │
│    registerViewerRoutes(app)          │
│    registerSSE(app)                   │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 4. 第一阶段：同步启动                 │
│    await app.listen(PORT, HOST)       │
│    writePidFile({ pid, port })        │
│    console.log("Worker ready")       │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 5. 第二阶段：异步初始化               │
│    initializeBackground()             │
│    ┌─────────────────────────────────┐│
│    │ a. DatabaseManager.initialize() ││
│    │    └─ runMigrations()           ││
│    │ b. resetStaleMessages()         ││
│    │ c. SearchManager.initialize()   ││
│    │    └─ ChromaSync.initialize()   ││
│    │ d. startOrphanReaper()          ││
│    │ e. processPendingQueues()       ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 6. 注册信号处理                       │
│    process.on('SIGTERM', shutdown)    │
│    process.on('SIGINT', shutdown)     │
└───────────────────────────────────────┘
```

---

## 3. Observation Handler 程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    Observation Handler 程序流程                    │
└────────────────────────────────────────────────────────────────────┘

observationHandler(adapter, stdinData)
        │
        ▼
┌───────────────────────────────────────┐
│ 1. 解析 stdin JSON                    │
│    const data = JSON.parse(stdinData) │
│    extract: tool_name, tool_input,    │
│             tool_output, session_id   │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 适配器转换                         │
│    const normalized =                 │
│      adapter.normalize(data)          │
│    // Claude Code vs Cursor 格式差异  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 标签剥离                           │
│    const clean =                      │
│      stripMemoryTagsFromJson(         │
│        normalized                     │
│      )                                │
│    // 移除 <private> 内容             │
│    // 移除 <claude-mem-context> 内容  │
│    // ReDoS 防护检查                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 4. 构造 API 请求                      │
│    const payload = {                  │
│      content_session_id: session_id,  │
│      tool_name: clean.tool_name,      │
│      tool_input: clean.tool_input,    │
│      tool_output: clean.tool_output   │
│    }                                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 5. HTTP POST                          │
│    fetch(`http://127.0.0.1:${port}    │
│      /api/session/observation`,       │
│      { method: 'POST', body: payload }│
│    )                                  │
└──────────┬────────────────────────────┘
           │
     ┌─────┴──────┐
     │            │
  成功         失败
     │            │
     ▼            ▼
┌─────────┐  ┌──────────────┐
│ exit(0) │  │ console.error│
│         │  │ exit(0)      │ ← 不阻塞 Claude Code
└─────────┘  └──────────────┘
```

---

## 4. 搜索请求处理程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    搜索请求处理程序流程                             │
└────────────────────────────────────────────────────────────────────┘

GET /api/search?query=xxx&project=yyy&limit=20
        │
        ▼
┌───────────────────────────────────────┐
│ SearchRoutes.handleSearch(req, res)    │
│ 1. 解析查询参数                       │
│    const { query, project, limit,     │
│            type, dateStart, dateEnd } │
│      = req.query                      │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ SearchManager.search(params)          │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ SearchOrchestrator.selectStrategy()   │
├───────────────────────────────────────┤
│                                       │
│  query为空?                           │
│  ├─ 是 → SQLiteSearchStrategy        │
│  │       (纯过滤模式)                 │
│  └─ 否 → ChromaSync 可用?            │
│          ├─ 是 → ChromaSearchStrategy │
│          │       (语义搜索模式)       │
│          └─ 否 → SQLiteSearchStrategy │
│                  (FTS5全文搜索模式)   │
│                                       │
└──────────┬────────────────────────────┘
           │
     ┌─────┴─────────────────┐
     ▼                       ▼
ChromaSearch              SQLiteSearch
     │                       │
     ▼                       ▼
┌──────────────┐    ┌──────────────────┐
│ 1. 向量化    │    │ 1. 构建 WHERE    │
│    查询文本  │    │    子句           │
│ 2. Chroma   │    │ 2. 应用过滤器    │
│    similarity│    │    ├ DateFilter   │
│    search    │    │    ├ ProjectFilter│
│ 3. 获取文档 │    │    └ TypeFilter   │
│    ID列表   │    │ 3. FTS5 匹配     │
│ 4. SQLite   │    │    (如有query)    │
│    批量查询 │    │ 4. 分页查询      │
└──────┬───────┘    └────────┬─────────┘
       │                     │
       └──────────┬──────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│ ResultFormatter.format(results)       │
├───────────────────────────────────────┤
│ 1. 按相关度/时间排序                  │
│ 2. 截断到 limit                      │
│ 3. 格式化为响应 JSON                 │
│    {                                  │
│      results: [{                      │
│        id, title, type, timestamp,    │
│        score?                         │
│      }],                              │
│      total, hasMore                   │
│    }                                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ res.json(formattedResults)            │
└───────────────────────────────────────┘
```

---

## 5. AI Agent 消息处理程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    AI Agent 消息处理程序流程                       │
└────────────────────────────────────────────────────────────────────┘

pending_message 入队
        │
        ▼
┌───────────────────────────────────────┐
│ SessionQueueProcessor.process()       │
│ 1. 从 DB 获取 pending 消息            │
│    SELECT * FROM pending_messages     │
│    WHERE status = 'pending'           │
│    ORDER BY id ASC LIMIT 10           │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 更新状态为 processing              │
│    UPDATE pending_messages            │
│    SET status = 'processing',         │
│        processing_started_at = NOW()  │
│    WHERE id = ?                       │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 选择 AI Agent                      │
│    getActiveAgent()                   │
│    ┌─────────────────────────────────┐│
│    │ OpenRouter selected & available?││
│    │   → OpenRouterAgent             ││
│    │ Gemini selected & available?    ││
│    │   → GeminiAgent                 ││
│    │ Default:                        ││
│    │   → SDKAgent                    ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 4. Agent 处理消息                     │
│    agent.processMessage(data)         │
│                                       │
│    ┌─────────────────────────────────┐│
│    │ message_type == 'observation'?  ││
│    │   → 提取 ParsedObservation     ││
│    │     {title, narrative, facts,   ││
│    │      concepts, files}           ││
│    │                                 ││
│    │ message_type == 'summary'?      ││
│    │   → 提取 ParsedSummary         ││
│    │     {request, investigated,     ││
│    │      learned, completed,        ││
│    │      next_steps}                ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
     ┌─────┴──────┐
     │            │
  成功         失败
     │            │
     ▼            ▼
┌─────────────┐ ┌───────────────────────┐
│ 5a. 存储    │ │ 5b. 错误处理          │
│ 结果到 DB   │ │                       │
│             │ │ retry_count < 3?      │
│ INSERT INTO │ │   → status='pending'  │
│ observations│ │   → retry_count++     │
│ /summaries  │ │                       │
│             │ │ retry_count >= 3?     │
│ UPDATE      │ │   → status='abandoned'│
│ status=     │ │   → 记录错误日志      │
│ 'completed' │ │                       │
└──────┬──────┘ └───────────────────────┘
       │
       ▼
┌───────────────────────────────────────┐
│ 6. ChromaDB 异步同步                  │
│    ChromaSync.syncDocuments([         │
│      formatObservationDocs(obs)       │
│    ])                                 │
│                                       │
│    分离文档策略：                     │
│    ├─ obs_{id}_narrative             │
│    ├─ obs_{id}_text                  │
│    └─ obs_{id}_fact_{index}          │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 7. SSE 广播                           │
│    SSEBroadcaster.broadcast({        │
│      type: 'new_observation',        │
│      data: observation               │
│    })                                 │
│    // 通知所有连接的 Viewer UI       │
└───────────────────────────────────────┘
```

---

## 6. 数据库迁移程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    数据库迁移程序流程                               │
└────────────────────────────────────────────────────────────────────┘

DatabaseManager.initialize()
        │
        ▼
┌───────────────────────────────────────┐
│ 1. 打开 SQLite 连接                   │
│    const db = new Database(           │
│      '~/.claude-mem/claude-mem.db'    │
│    )                                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 设置 PRAGMA                        │
│    journal_mode = WAL                 │
│    mmap_size = 268435456              │
│    cache_size = -64000                │
│    foreign_keys = ON                  │
│    synchronous = NORMAL               │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 检查当前版本                       │
│    SELECT value FROM meta             │
│    WHERE key = 'schema_version'       │
│    ┌─────────────────────────────────┐│
│    │ 表不存在？                      ││
│    │   → currentVersion = 0          ││
│    │ 存在？                          ││
│    │   → currentVersion = parseInt() ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 4. 迁移循环                           │
│    for (version = current+1;          │
│         version <= LATEST;            │
│         version++)                    │
│    ┌─────────────────────────────────┐│
│    │ a. BEGIN TRANSACTION            ││
│    │ b. 执行迁移 SQL                 ││
│    │    migrations[version]()        ││
│    │ c. UPDATE meta                  ││
│    │    SET value = version           ││
│    │    WHERE key = 'schema_version' ││
│    │ d. COMMIT                       ││
│    │                                 ││
│    │ 失败？                          ││
│    │   → ROLLBACK                    ││
│    │   → 记录错误                    ││
│    │   → 抛出异常                    ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 5. 迁移完成                           │
│    log("Database at version ${v}")   │
└───────────────────────────────────────┘
```

---

## 7. SSE 实时推送程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    SSE 实时推送程序流程                             │
└────────────────────────────────────────────────────────────────────┘

Browser 请求 GET /stream
        │
        ▼
┌───────────────────────────────────────┐
│ SSE 连接建立                          │
│ res.setHeader('Content-Type',        │
│   'text/event-stream')               │
│ res.setHeader('Cache-Control',       │
│   'no-cache')                        │
│ res.setHeader('Connection',          │
│   'keep-alive')                      │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ SSEBroadcaster.addClient(res)        │
│ clientId = generateId()               │
│ clients.set(clientId, res)            │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 发送 initial_load 事件                │
│ 1. 查询最近 50 条数据                 │
│ 2. res.write(`event: initial_load\n`)│
│    res.write(`data: ${JSON.stringify  │
│      (items)}\n\n`)                   │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 事件循环（等待数据变更）              │
│                                       │
│ ◆ 新观察入库：                        │
│   broadcast({                         │
│     event: 'new_observation',         │
│     data: observation                 │
│   })                                  │
│                                       │
│ ◆ 新摘要入库：                        │
│   broadcast({                         │
│     event: 'new_summary',             │
│     data: summary                     │
│   })                                  │
│                                       │
│ ◆ 新提示入库：                        │
│   broadcast({                         │
│     event: 'new_prompt',              │
│     data: prompt                      │
│   })                                  │
│                                       │
│ ◆ 处理状态变更：                      │
│   broadcast({                         │
│     event: 'processing_status',       │
│     data: { pending, processing }     │
│   })                                  │
└──────────┬────────────────────────────┘
           │
           ▼ (连接关闭)
┌───────────────────────────────────────┐
│ SSEBroadcaster.removeClient(clientId)│
│ clients.delete(clientId)              │
└───────────────────────────────────────┘
```

---

## 8. 优雅关闭程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    优雅关闭程序流程                                │
└────────────────────────────────────────────────────────────────────┘

SIGTERM / SIGINT 信号
        │
        ▼
┌───────────────────────────────────────┐
│ GracefulShutdown.initiate()           │
│ isShuttingDown = true                 │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 1. 停止接受新请求                     │
│    server.close()                     │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 等待进行中的请求完成               │
│    await Promise.race([              │
│      waitForRequests(),              │
│      timeout(10000)                  │  ← 最多等 10 秒
│    ])                                │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 关闭 SSE 连接                      │
│    SSEBroadcaster.closeAll()         │
│    // 通知所有客户端连接关闭         │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 4. 关闭数据库连接                     │
│    DatabaseManager.close()           │
│    // 确保 WAL checkpoint            │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 5. 清理 PID 文件                      │
│    unlinkSync(pidFilePath)           │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 6. 退出进程                           │
│    process.exit(0)                    │
└───────────────────────────────────────┘
```

---

## 9. ChromaDB 同步程序流程

```
┌────────────────────────────────────────────────────────────────────┐
│                    ChromaDB 同步程序流程                           │
└────────────────────────────────────────────────────────────────────┘

ChromaSync.initialize()
        │
        ▼
┌───────────────────────────────────────┐
│ 1. 平台检查                           │
│    if (process.platform === 'win32') │
│      return disabled                  │  ← Windows 不支持
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 2. 连接 MCP Chroma 服务器             │
│    mcpClient.connect()               │
│    if (timeout > 5s)                 │
│      return disabled                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 3. 获取/创建 Collection               │
│    collection = "claude-mem-memories"│
└──────────┬────────────────────────────┘
           │
           ▼
ChromaSync.syncAll()
           │
           ▼
┌───────────────────────────────────────┐
│ 4. 获取 Chroma 现有文档 ID            │
│    existingIds = chroma.getIds()     │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 5. 查询 SQLite 缺失记录              │
│    ┌─────────────────────────────────┐│
│    │ a. observations                 ││
│    │    WHERE id NOT IN existingIds  ││
│    │ b. summaries                    ││
│    │    WHERE id NOT IN existingIds  ││
│    │ c. user_prompts                 ││
│    │    WHERE id NOT IN existingIds  ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 6. 文档分离和格式化                   │
│    ┌─────────────────────────────────┐│
│    │ observation → 多个文档：        ││
│    │   obs_{id}_narrative            ││
│    │   obs_{id}_text                 ││
│    │   obs_{id}_fact_0               ││
│    │   obs_{id}_fact_1               ││
│    │   ...                           ││
│    │                                 ││
│    │ summary → 多个文档：            ││
│    │   sum_{id}_request              ││
│    │   sum_{id}_investigated         ││
│    │   sum_{id}_learned              ││
│    │   sum_{id}_completed            ││
│    │   sum_{id}_next_steps           ││
│    │                                 ││
│    │ prompt → 单个文档：             ││
│    │   prompt_{id}                   ││
│    └─────────────────────────────────┘│
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ 7. 批量上传                           │
│    BATCH_SIZE = 100                   │
│    for (batch of chunks(docs, 100))  │
│      chroma.addDocuments(batch)       │
│    end                                │
└───────────────────────────────────────┘
```
