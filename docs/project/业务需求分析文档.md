# Claude-Mem 业务需求分析文档

> 版本：v9.1.1 | 更新日期：2026-02-08

---

## 1. 项目概述

### 1.1 项目背景

Claude Code 是 Anthropic 公司推出的 AI 编程助手 CLI 工具。然而，Claude Code 的每次会话相互独立，不具备跨会话的记忆能力。开发者在多次会话中重复描述项目背景、技术决策和已完成工作，造成了大量的时间浪费和 Token 消耗。

Claude-Mem 正是为解决这一痛点而诞生的 **Claude Code 插件**，它为 Claude Code 提供了跨会话的持久化记忆系统。

### 1.2 项目定位

| 维度 | 描述 |
|------|------|
| **产品类型** | Claude Code 插件（Plugin） |
| **目标用户** | 使用 Claude Code 进行日常开发的软件工程师 |
| **核心价值** | 自动记录、压缩、检索开发历史，消除跨会话的信息断裂 |
| **商业模式** | 开源核心（AGPL-3.0）+ Pro 付费增值 |
| **技术栈** | TypeScript / Bun / SQLite / ChromaDB / React |

### 1.3 核心问题域

```
问题1：会话孤岛
  └─ 每次启动 Claude Code 都是全新起点，丢失前序工作上下文

问题2：重复劳动
  └─ 反复解释项目结构、技术选型、已知 Bug 等信息

问题3：知识流失
  └─ 重要的技术发现、调试过程、决策推理无法沉淀

问题4：Token 浪费
  └─ 缺乏历史上下文导致 AI 重复探索已知领域
```

---

## 2. 业务需求分析

### 2.1 核心功能需求

#### FR-01：自动观察记录

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-01 |
| **优先级** | P0（核心） |
| **描述** | 系统自动捕获 Claude Code 每次工具调用的输入和输出，提取结构化观察数据 |
| **触发条件** | Claude Code 执行任何工具（Bash、Read、Write、Edit 等） |
| **输出** | 结构化观察记录（标题、叙述、事实、概念、文件列表） |
| **验收标准** | 1. 无需用户手动操作<br>2. 观察数据包含完整的结构化字段<br>3. 隐私标签内的内容不被记录 |

#### FR-02：会话摘要生成

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-02 |
| **优先级** | P0（核心） |
| **描述** | 会话结束时自动生成结构化摘要 |
| **输出字段** | request（请求）、investigated（调查）、learned（学到）、completed（完成）、next_steps（后续步骤） |
| **验收标准** | 1. 会话结束自动触发<br>2. 摘要准确反映会话内容<br>3. 通过 AI Agent 压缩生成 |

#### FR-03：上下文注入

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-03 |
| **优先级** | P0（核心） |
| **描述** | 新会话启动时自动注入历史上下文 |
| **注入内容** | 最近 50 条观察记录 + 最后一个会话摘要 + 时间线 |
| **验收标准** | 1. 无需用户手动操作<br>2. 上下文格式化为可读的时间线<br>3. Token 消耗可控 |

#### FR-04：记忆搜索

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-04 |
| **优先级** | P0（核心） |
| **描述** | 用户可搜索历史记忆，支持语义搜索和过滤 |
| **搜索方式** | 关键词搜索、语义向量搜索、混合搜索 |
| **过滤器** | 日期范围、项目名称、观察类型 |
| **验收标准** | 1. 搜索响应时间 < 2 秒<br>2. 语义搜索准确匹配相关内容<br>3. 三层工作流最小化 Token 消耗 |

#### FR-05：记忆可视化

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-05 |
| **优先级** | P1（重要） |
| **描述** | 提供 Web UI 查看和管理记忆数据 |
| **功能** | 实时流推送、无限滚动、项目过滤、主题切换、统计信息 |
| **验收标准** | 1. 浏览器访问 localhost:37777<br>2. SSE 实时更新<br>3. 响应式设计适配移动端 |

#### FR-06：手动记忆保存

| 属性 | 描述 |
|------|------|
| **需求编号** | FR-06 |
| **优先级** | P1（重要） |
| **描述** | 用户可手动保存重要信息到记忆系统 |
| **接口** | `save_memory(text, title, project)` |
| **验收标准** | 通过 MCP 工具或搜索技能调用 |

### 2.2 非功能需求

#### NFR-01：性能

| 指标 | 要求 |
|------|------|
| Hook 响应时间 | < 500ms（不阻塞 Claude Code 工作流） |
| Worker 启动时间 | 第一阶段 < 2 秒，后台初始化 < 30 秒 |
| 搜索响应时间 | < 2 秒 |
| 内存占用 | Worker 常驻 < 100MB |

#### NFR-02：可靠性

| 指标 | 要求 |
|------|------|
| 数据持久化 | SQLite WAL 模式保证写入安全 |
| 进程管理 | 优雅关闭、孤儿进程清理、PID 文件跟踪 |
| 错误恢复 | 消息队列 + 自动重试 |
| 退出码策略 | 错误不阻塞 Claude Code 正常使用 |

#### NFR-03：隐私

| 指标 | 要求 |
|------|------|
| 隐私标签 | `<private>` 标签内容绝不存储 |
| 数据存储 | 全部本地存储，不上传任何远程服务器 |
| 边缘处理 | 标签在 Hook 层即被剥离，不到达 Worker/数据库 |

#### NFR-04：跨平台

| 平台 | 支持程度 |
|------|---------|
| macOS | 完整支持 |
| Linux | 完整支持 |
| Windows | 完整支持（Chroma 向量搜索除外） |

#### NFR-05：可扩展性

| 维度 | 要求 |
|------|------|
| AI 提供者 | 支持 Claude SDK / Gemini / OpenRouter 三种 Agent |
| IDE 集成 | 支持 Claude Code / Cursor 两种 IDE |
| 搜索策略 | 策略模式支持新增搜索算法 |

---

## 3. 用户场景分析

### 3.1 典型用户画像

```
角色：全栈开发工程师
工具：每天使用 Claude Code 进行 4-8 小时的开发工作
痛点：
  - 每次启动 Claude Code 需要重新解释项目背景
  - 昨天调试的 Bug 今天又被 AI 重新探索
  - 重要的技术决策缺乏记录
期望：
  - AI 能记住之前做过什么
  - 自动注入相关上下文
  - 能搜索过往的工作记忆
```

### 3.2 核心用户故事

| 编号 | 用户故事 | 验收标准 |
|------|---------|---------|
| US-01 | 作为开发者，我希望 AI 记住上次会话做了什么，这样我不需要重复解释 | 新会话自动注入最近的观察和摘要 |
| US-02 | 作为开发者，我希望搜索过往的调试记录，快速找到之前的解决方案 | 语义搜索返回相关的历史观察 |
| US-03 | 作为开发者，我希望标记敏感信息不被记录，保护隐私 | `<private>` 包裹的内容不出现在数据库 |
| US-04 | 作为开发者，我希望直观地浏览记忆时间线 | Web UI 展示按时间排列的观察、摘要和提示 |
| US-05 | 作为开发者，我希望系统自动运行不干扰我的工作流 | Hook 静默执行，错误不中断 Claude Code |
| US-06 | 作为开发者，我希望在多个项目中使用记忆系统 | 数据按项目隔离，搜索支持项目过滤 |

### 3.3 使用流程

```
日常使用流程：

1. 启动 Claude Code
   ├─ claude-mem 自动启动 Worker 服务
   ├─ 注入最近的观察和摘要上下文
   └─ 用户看到上次工作的延续

2. 正常开发工作
   ├─ 每次工具调用自动生成观察记录
   ├─ 观察数据异步存储到 SQLite + Chroma
   └─ Web UI 实时更新

3. 需要搜索历史
   ├─ 用户问 "之前是怎么解决 XX 问题的？"
   ├─ mem-search 技能自动触发
   └─ 返回相关的历史记忆

4. 会话结束
   ├─ 自动生成结构化摘要
   ├─ 标记会话为已完成
   └─ 记忆持久化，等待下次注入
```

---

## 4. 竞品分析

| 特性 | Claude-Mem | 手动 CLAUDE.md | 其他记忆工具 |
|------|-----------|---------------|-------------|
| 自动化程度 | 全自动（Hook 驱动） | 完全手动 | 部分自动 |
| 数据结构化 | 结构化（标题/事实/概念） | 非结构化文本 | 因工具而异 |
| 语义搜索 | 支持（ChromaDB） | 不支持 | 少数支持 |
| 隐私控制 | 标签级粒度 | 无 | 基本 |
| Token 优化 | 三层搜索工作流 | 无 | 基本 |
| 可视化 | React Web UI | 无 | 因工具而异 |
| 跨平台 | Windows/Mac/Linux | 不适用 | 因工具而异 |

---

## 5. 需求优先级矩阵

```
        高价值
          │
    P0核心 │  P1重要
  ┌────────┼────────┐
  │ 观察记录│ 可视化  │
  │ 摘要生成│ 手动保存│
  │ 上下文  │ Cursor  │
  │ 注入    │ 集成    │
高├────────┼────────┤
紧│ 搜索   │ Pro增值 │
急│ 功能   │ 功能    │
  │        │ 数据导出│
  └────────┼────────┘
          │
        低价值
```

---

## 6. 约束与假设

### 6.1 技术约束

- 依赖 Claude Code 的 Hook 机制（5 个生命周期钩子）
- SQLite 单文件数据库，不支持并发写入
- ChromaDB 在 Windows 平台暂不可用
- Bun 运行时为必须依赖（性能考量）

### 6.2 业务假设

- 用户使用 Claude Code 进行日常开发工作
- 用户愿意在本地运行常驻 Worker 服务（端口 37777）
- 大部分用户不需要跨设备同步记忆数据
- Pro 功能通过增强 UI 而非限制核心功能来盈利

---

## 7. 术语表

| 术语 | 定义 |
|------|------|
| **Observation** | 观察记录，从工具调用中自动提取的结构化数据 |
| **Summary** | 会话摘要，会话结束时 AI 生成的结构化总结 |
| **Hook** | 钩子，Claude Code 生命周期中的扩展点 |
| **Worker** | 后台服务进程，处理 AI 压缩和数据存储 |
| **Context Injection** | 上下文注入，会话启动时自动提供历史信息 |
| **Token** | AI 处理文本的基本单位，直接影响成本 |
| **Chroma** | 向量数据库，用于语义搜索 |
| **MCP** | Model Context Protocol，模型上下文协议 |
| **SDK Agent** | 使用 Claude Agent SDK 的 AI 代理 |
| **Prompt** | 用户向 Claude Code 发送的消息 |
