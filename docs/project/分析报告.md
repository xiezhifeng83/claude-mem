# Claude-Mem 代码库分析报告

> 分析日期：2026-02-08 | 项目版本：v9.1.1

---

## 一、项目元数据

| 属性 | 值 |
|------|-----|
| **项目名称** | claude-mem |
| **版本** | 9.1.1 |
| **许可证** | AGPL-3.0 |
| **作者** | Alex Newman |
| **仓库** | https://github.com/thedotmack/claude-mem.git |
| **文档站** | https://docs.claude-mem.ai (Mintlify) |
| **开发状态** | 活跃开发中（27+ 开放 PR，100+ 已关闭 PR） |

---

## 二、目录结构概览

```
claude-mem/
├── src/                    # 源代码
├── plugin/                 # 已构建的插件（发布版本）
├── tests/                  # 测试套件
├── scripts/                # 构建和工具脚本
├── docs/                   # 文档（MDX 格式）
├── .github/               # GitHub Actions 工作流
├── cursor-hooks/          # Cursor 编辑器钩子
├── ragtime/               # 第三方或辅助工具
├── Auto Run Docs/         # 自动化文档
└── package.json, tsconfig.json, CLAUDE.md, PLAN.md, LICENSE
```

---

## 三、源代码结构分析（src/）

### 3.1 核心服务（src/services/）— 应用架构的心脏

```
src/services/
├── worker-service.ts           # 主编排器（~1000行）- 启动 Express 服务器、后台初始化
├── worker-types.ts             # Worker 类型定义
├── Context.ts                  # 上下文接口
├── context-generator.ts        # 上下文生成函数
│
├── worker/                     # 业务逻辑（Worker 线程）
│   ├── DatabaseManager.ts      # 数据库连接管理
│   ├── SessionManager.ts       # 会话生命周期（初始化、继续、完成）
│   ├── SearchManager.ts        # 搜索编排（~1500 行）- 语义搜索、混合搜索
│   ├── SDKAgent.ts             # Claude Agent SDK 代理（~600 行）
│   ├── GeminiAgent.ts          # Google Gemini 代理支持
│   ├── OpenRouterAgent.ts      # OpenRouter 代理支持
│   ├── TimelineService.ts      # 时间线构建
│   ├── FormattingService.ts    # 结果格式化（表格/富文本）
│   ├── PaginationHelper.ts     # 分页逻辑
│   ├── SettingsManager.ts      # 设置管理
│   ├── BranchManager.ts        # 版本切换管理
│   ├── ProcessRegistry.ts      # 进程跟踪
│   ├── SSEBroadcaster.ts       # 服务器推送事件
│   │
│   ├── http/                   # HTTP 路由层
│   │   └── routes/
│   │       ├── DataRoutes.ts       # 数据导入/导出
│   │       ├── SearchRoutes.ts     # 搜索端点
│   │       ├── SessionRoutes.ts    # 会话管理端点
│   │       ├── SettingsRoutes.ts   # 设置端点
│   │       ├── MemoryRoutes.ts     # 内存端点
│   │       ├── LogsRoutes.ts       # 日志端点
│   │       └── ViewerRoutes.ts     # UI 查看器端点
│   │
│   ├── search/                 # 搜索子系统（高度模块化）
│   │   ├── SearchOrchestrator.ts   # 策略选择和协调
│   │   ├── ResultFormatter.ts      # 输出格式化
│   │   ├── TimelineBuilder.ts      # 时间线构建
│   │   ├── types.ts
│   │   ├── index.ts
│   │   ├── strategies/
│   │   │   ├── SearchStrategy.ts        # 抽象基类
│   │   │   ├── ChromaSearchStrategy.ts  # 向量搜索（语义）
│   │   │   ├── SQLiteSearchStrategy.ts  # 过滤器搜索
│   │   │   └── HybridSearchStrategy.ts  # 元数据 + 语义排序
│   │   └── filters/
│   │       ├── DateFilter.ts       # 日期范围过滤
│   │       ├── ProjectFilter.ts    # 项目过滤
│   │       └── TypeFilter.ts       # 类型过滤
│   │
│   ├── agents/                 # AI 代理专用
│   │   ├── FallbackErrorHandler.ts
│   │   ├── ObservationBroadcaster.ts
│   │   ├── ResponseProcessor.ts
│   │   ├── SessionCleanupHelper.ts
│   │   └── types.ts
│   │
│   ├── session/                # 会话处理
│   ├── events/                 # 事件系统
│   └── validation/             # 输入验证
│
├── sqlite/                     # SQLite 数据库层
│   ├── Database.ts             # 数据库连接和初始化（bun:sqlite）
│   ├── SessionStore.ts         # 核心 CRUD（~2000 行）
│   ├── SessionSearch.ts        # 查询构建（~600 行）
│   ├── PendingMessageStore.ts  # 队列消息管理
│   ├── types.ts                # 数据库实体类型
│   ├── transactions.ts         # 事务管理
│   ├── migrations.ts           # 迁移系统（~500 行）
│   ├── Import.ts
│   ├── Observations.ts
│   ├── Prompts.ts
│   ├── Sessions.ts
│   ├── Summaries.ts
│   ├── Timeline.ts
│   │
│   ├── migrations/
│   │   └── runner.ts           # 迁移执行器
│   │
│   ├── observations/           # 观察存储
│   │   ├── files.ts
│   │   ├── get.ts
│   │   ├── recent.ts
│   │   ├── store.ts
│   │   └── types.ts
│   │
│   ├── sessions/               # 会话存储
│   │   ├── create.ts
│   │   ├── get.ts
│   │   └── types.ts
│   │
│   ├── prompts/
│   ├── summaries/
│   ├── timeline/
│   └── import/
│       └── bulk.ts
│
├── sync/                       # 向量数据库同步
│   └── ChromaSync.ts           # ChromaDB MCP 同步（~1000 行）
│
├── context/                    # 上下文生成引擎
│   ├── ContextBuilder.ts       # 上下文构建
│   ├── ContextConfigLoader.ts  # 配置加载
│   ├── ObservationCompiler.ts  # 观察编译
│   ├── TokenCalculator.ts      # Token 计数
│   ├── types.ts
│   ├── index.ts
│   │
│   ├── formatters/
│   │   ├── ColorFormatter.ts   # ANSI 彩色输出
│   │   └── MarkdownFormatter.ts # Markdown 输出
│   │
│   └── sections/
│       ├── HeaderRenderer.ts   # 头部渲染
│       ├── TimelineRenderer.ts # 时间线渲染
│       ├── SummaryRenderer.ts  # 总结渲染
│       └── FooterRenderer.ts   # 页脚渲染
│
├── domain/                     # 域服务
│   ├── ModeManager.ts          # 运行模式管理
│   └── types.ts
│
├── queue/                      # 消息队列处理
│   └── SessionQueueProcessor.ts # 会话队列处理（空闲超时修复）
│
├── infrastructure/             # 基础设施（进程管理）
│   ├── ProcessManager.ts       # 进程生命周期（fork、PID、信号）
│   ├── HealthMonitor.ts        # 健康检查和端口监控
│   ├── GracefulShutdown.ts     # 优雅关闭逻辑
│   └── index.ts
│
├── integrations/               # IDE 集成
│   ├── CursorHooksInstaller.ts # Cursor 编辑器集成
│   └── types.ts
│
├── server/                     # HTTP 服务器
│   ├── Server.ts               # Express 应用程序
│   ├── ErrorHandler.ts         # 错误处理中间件
│   ├── Middleware.ts           # 通用中间件
│   └── index.ts
│
└── CLAUDE.md                   # 内部上下文
```

### 3.2 CLI 和事件处理（src/cli/）

```
src/cli/
├── claude-md-commands.ts       # CLAUDE.md 命令处理
├── hook-command.ts             # Hook 命令接口
├── stdin-reader.ts             # stdin 流处理
├── types.ts
│
├── handlers/                   # Hook 处理程序
│   ├── context.ts              # SessionStart 上下文注入
│   ├── observation.ts          # PostToolUse 观察记录
│   ├── session-init.ts         # UserPromptSubmit 会话初始化
│   ├── session-complete.ts     # Stop 会话完成
│   ├── summarize.ts            # 总结生成
│   ├── file-edit.ts            # 文件编辑跟踪
│   ├── user-message.ts         # 用户消息处理
│   └── index.ts
│
└── adapters/                   # IDE 适配器
    ├── claude-code.ts          # Claude Code 适配器
    ├── cursor.ts               # Cursor 适配器
    ├── raw.ts                  # 原始数据适配器
    └── index.ts
```

### 3.3 工具和共享模块

```
src/utils/
├── logger.ts                   # 日志系统（结构化日志）
├── claude-md-utils.ts          # CLAUDE.md 处理
├── tag-stripping.ts            # <private> 标签移除
├── transcript-parser.ts        # 转录文本解析
├── cursor-utils.ts             # Cursor 特定工具
├── bun-path.ts                 # Bun 路径工具
├── error-messages.ts           # 错误消息常量
└── project-filter.ts           # 项目过滤工具

src/shared/
├── paths.ts                    # 配置路径（~/.claude-mem）
├── path-utils.ts               # 路径工具函数
├── SettingsDefaultsManager.ts  # 设置管理
├── EnvManager.ts               # 环境变量管理
├── hook-constants.ts           # Hook 常量
├── worker-utils.ts             # Worker 工具
├── timeline-formatting.ts      # 时间线格式化工具
└── transcript-parser.ts

src/constants/
└── observation-metadata.ts     # 观察元数据常数

src/types/
├── database.ts                 # 数据库类型
├── transcript.ts               # 转录类型
└── hook-response.ts            # Hook 响应类型

src/sdk/
├── index.ts                    # 导出
├── parser.ts                   # 解析库
└── prompts.ts                  # SDK 提示模板

src/servers/
└── mcp-server.ts               # MCP 服务器实现

src/bin/
├── cleanup-duplicates.ts       # 数据清理脚本
└── import-xml-observations.ts  # XML 导入脚本
```

### 3.4 UI 组件（src/ui/viewer/）

```
src/ui/viewer/
├── App.tsx                     # React 应用入口
├── index.tsx                   # 渲染入口
├── types.ts                    # UI 类型定义
│
├── components/                 # React 组件（14 个 TSX 文件）
│   ├── ContextSettingsModal.tsx    # 上下文设置模态
│   ├── ErrorBoundary.tsx           # 错误边界
│   ├── Feed.tsx                    # 内存流列表（无限滚动）
│   ├── Header.tsx                  # 头部导航
│   ├── ObservationCard.tsx         # 观察卡片
│   ├── PromptCard.tsx              # 提示卡片
│   ├── SummaryCard.tsx             # 总结卡片
│   ├── LogsModal.tsx               # 日志模态（Chrome DevTools 风格）
│   ├── TerminalPreview.tsx         # 终端预览
│   ├── ThemeToggle.tsx             # 主题切换
│   ├── GitHubStarsButton.tsx       # GitHub Stars 按钮
│   └── ScrollToTop.tsx             # 滚动到顶部
│
├── hooks/                      # React Hooks（8 个）
│   ├── useSSE.ts                   # SSE 连接管理、自动重连
│   ├── useTheme.ts                 # 主题偏好管理（localStorage 持久化）
│   ├── usePagination.ts            # API 分页管理
│   ├── useSettings.ts              # 设置保存和加载
│   ├── useStats.ts                 # 统计数据刷新
│   ├── useSpinningFavicon.ts       # 处理中动画 favicon
│   ├── useContextPreview.ts        # 上下文预览控制
│   └── useGitHubStars.ts           # GitHub Stars 计数
│
├── utils/                      # UI 工具函数
├── constants/                  # UI 常量
└── assets/                     # 资源文件
    ├── SVG 图标
    ├── Logo 和 Logomark (webp)
    └── viewer-template.html    # 模板 HTML
```

---

## 四、插件结构分析（plugin/）

```
plugin/
├── .claude-plugin/            # Claude Code 插件配置
│   └── plugin.json            # 插件清单（名称、版本、描述）
├── package.json               # 插件包（私有）
├── CLAUDE.md
├── .mcp.json
│
├── hooks/                     # 已编译的 Hook 脚本
│   └── hooks.json             # 5 个生命周期钩子配置
│       ├── Setup              # 初始化插件
│       ├── SessionStart       # 启动、清除、紧凑
│       ├── UserPromptSubmit   # 初始化会话
│       ├── PostToolUse        # 记录观察
│       └── Stop               # 总结、完成
│
├── scripts/                   # 已编译的脚本（CJS）
│   ├── worker-service.cjs     # 主要 Worker 可执行文件（~1.8MB）
│   ├── context-generator.cjs  # 上下文生成器（~71KB）
│   ├── mcp-server.cjs         # MCP 服务器（~341KB）
│   ├── worker-cli.js          # CLI 工具
│   ├── smart-install.js       # 智能安装脚本
│   ├── bun-runner.js          # Bun 运行器
│   ├── worker-wrapper.cjs
│   └── setup.sh               # 设置脚本
│
├── skills/                    # 技能（自动调用）
│   └── mem-search/
│       └── SKILL.md           # 内存搜索技能文档
│
├── commands/                  # 命令定义
│   ├── do.md                  # 任务执行命令
│   └── make-plan.md           # 计划制定命令
│
├── modes/                     # 运行模式配置（44 个语言/模式）
│   ├── code.json              # 默认代码模式
│   ├── code--zh.json          # 中文模式
│   ├── code--chill.json       # Chill 模式
│   └── email-investigation.json
│
└── ui/                        # UI 资源
    └── viewer.html            # 已构建的 UI（2875 行，含完整 CSS）
```

---

## 五、测试结构分析（tests/）

```
tests/
├── sqlite/                     # SQLite 测试
│   ├── Database.test.ts
│   ├── SessionStore.test.ts
│   └── ...
├── worker/                     # Worker 测试
│   ├── agents/                 # Agent 测试
│   ├── search/                 # 搜索测试
│   └── ...
├── context/                    # 上下文生成测试
├── infrastructure/             # 基础设施测试
│   ├── ProcessManager.test.ts
│   ├── HealthMonitor.test.ts
│   └── ...
├── server/                     # 服务器测试
├── services/                   # 服务测试
├── utils/                      # 工具测试
├── shared/                     # 共享模块测试
├── integration/                # 集成测试
├── cursor-context-update.test.ts
├── cursor-hooks-json-utils.test.ts
├── gemini_agent.test.ts
├── session_store.test.ts
├── zombie-prevention.test.ts
└── ...
```

---

## 六、构建系统分析

### 6.1 package.json 脚本

```
开发：
  npm run dev              # 构建并同步到市场
  npm run build            # 构建钩子（ESBuild）
  npm run build-and-sync   # 完整构建流程

Worker 管理：
  npm run worker:start     # 启动 Worker 服务
  npm run worker:stop      # 停止 Worker 服务
  npm run worker:restart   # 重启 Worker
  npm run worker:status    # 检查状态
  npm run worker:logs      # 查看日志
  npm run worker:tail      # 尾随日志

队列管理：
  npm run queue            # 检查待处理队列
  npm run queue:process    # 处理队列
  npm run queue:clear      # 清除失败队列

测试：
  npm run test             # 运行所有测试
  npm run test:sqlite      # SQLite 测试
  npm run test:agents      # Agent 测试
  npm run test:search      # 搜索测试

发布：
  npm run release          # 发布新版本
  npm run changelog:generate # 生成更新日志
```

### 6.2 编译配置

```
tsconfig.json
  target: ES2022
  module: ESNext
  strict: true
  declaration: true

ESBuild 配置 (build-hooks.js)：
  输入：src/services/worker-service.ts, src/servers/mcp-server.ts
  输出：plugin/scripts/*.cjs
  格式：CJS + Node18 目标
  特殊处理：bun:sqlite 外部依赖、版本注入
  Shebang：#!/usr/bin/env bun (worker) / #!/usr/bin/env node (MCP)

ESBuild 配置 (build-viewer.js)：
  Entry: src/ui/viewer/index.tsx
  Bundle: ESBuild → IIFE 格式
  Output: plugin/ui/viewer-bundle.js
  资源：字体、图标 SVG 复制
  模板：src/ui/viewer-template.html → plugin/ui/viewer.html
```

### 6.3 关键依赖

```
核心依赖：
  @anthropic-ai/claude-agent-sdk ^0.1.76    # AI 代理 SDK
  @modelcontextprotocol/sdk ^1.25.1         # MCP 通信
  express ^4.18.2                            # HTTP 服务器
  react ^18.3.1                              # UI 框架
  yaml ^2.8.2                                # 配置解析
  bun:sqlite                                 # 数据库（内置）

引擎要求：
  Node.js >= 18
  Bun >= 1.0
```

---

## 七、核心业务逻辑分析

### 7.1 Hook 生命周期（核心流程）

```
Hook 配置 (plugin/hooks/hooks.json)：

Setup              → 初始化插件
↓
SessionStart       → 启动 Worker → 注入上下文（文件、最近观察）
↓
UserPromptSubmit   → 初始化会话记录（session_id、content_session_id）
↓
PostToolUse        → 记录观察（工具使用、输出、推理）[重复 N 次]
↓
Stop               → 生成总结 → 标记会话完成 → 清理资源
```

### 7.2 观察存储流程

```
PostToolUse 钩子
  ↓
提取工具响应 (tool_input, tool_output)
  ↓
应用标签剥离 (stripMemoryTagsFromJson)
  ↓
SDK 解析器 (ParsedObservation 提取结构化数据)
  ↓
数据库存储事务
  ├─ INSERT observations (narrative, facts, concepts, files)
  ├─ UPDATE sdk_sessions.prompt_counter
  └─ INSERT pending_messages (observation, status=processing)
  ↓
异步 Chroma 同步 (formatObservationDocs → addDocuments)
  ├─ 分离文档 (narrative, text, facts)
  └─ 批量上传 (BATCH_SIZE=100)
```

### 7.3 搜索系统（三层工作流）

```
搜索路径决策树：
├─ 无查询文本 (仅过滤器)
│  └─ SQLite 直接过滤 (支持日期范围)
├─ 有查询文本 + Chroma 可用
│  └─ 语义搜索 → 近 90 天过滤 → SQLite 详情获取
└─ 有查询文本 + 无 Chroma
   └─ SQLite FTS5 全文搜索

三层工作流（10 倍 Token 节省）：
  第 1 层：搜索索引     ~50-100 tokens/结果
  第 2 层：时间线上下文  ~200-300 tokens
  第 3 层：批量获取详情  ~500-1000 tokens/观察
```

### 7.4 AI Agent 系统

```
Agent 抽象层：
  SDKAgent      → 使用 Claude Agent SDK（默认，事件驱动循环）
  GeminiAgent   → Google Gemini 支持（回退）
  OpenRouterAgent → OpenRouter 代理支持（回退）

选择优先级：
  1. OpenRouter（如果选中且可用）
  2. Gemini（如果选中且可用）
  3. Claude SDK（默认）

会话恢复逻辑：
  ├─ 第一次提示 (prompt_number=1) → 不恢复，开始新 SDK 会话
  ├─ 后续提示 (prompt_number>1) → resume(memorySessionId)
  └─ Worker 重启 → 丢弃 stale memory_session_id，强制新会话
```

### 7.5 隐私标签系统

```
双标签系统（边缘处理，防止数据到达 Worker/数据库）：

  <claude-mem-context>...</claude-mem-context>
    → 系统级自动注入控制（防止递归存储）

  <private>...</private>
    → 用户手动隐私控制（选择不持久化内容）

ReDoS 防护：
  MAX_TAG_COUNT = 100（单个内容块最多 100 个标签）
  正则表达式处理前计数，防止灾难性回溯
```

---

## 八、Viewer UI 架构分析

### 8.1 React 架构

```
App.tsx（主应用，React 18）
├─ 智能数据合并策略：
│   有项目过滤 → 使用 API 分页数据
│   无过滤 → 合并 SSE 直播数据 + 分页数据，按 ID 去重
│
├─ 核心组件（14 个 TSX）
│   Feed.tsx          → 无限滚动列表（IntersectionObserver）
│   Header.tsx        → 导航栏（Logo、项目过滤、主题切换）
│   ObservationCard   → 观察卡片
│   SummaryCard       → 摘要卡片
│   PromptCard        → 提示卡片
│   ContextSettings   → 设置面板
│   LogsModal         → 控制台日志
│
└─ 自定义 Hooks（8 个）
    useSSE            → EventSource 连接管理、自动重连
    useTheme          → 主题偏好（localStorage 持久化）
    usePagination     → API 分页管理
    useSettings       → 设置保存和加载
    useStats          → 统计数据刷新
```

### 8.2 主题系统

```
HTML 模板 (viewer.html)：
  根级变量定义 Light/Dark 两套配色
  系统偏好检测 (@media prefers-color-scheme)
  200+ 个 CSS 变量
  精细化卡片配色（摘要金色、提示紫色、观察蓝色）

响应式设计 4 个断点：
  Mobile (≤480px) / Small Tablet (480-600px) / Tablet (600-768px) / Desktop
```

---

## 九、关键架构特征

### 9.1 数据库架构

- SQLite3 + WAL 模式（性能优化）
- 17+ 迁移版本（v4 → v20 历史演变）
- 核心表：sdk_sessions、observations、user_prompts、session_summaries、pending_messages、meta
- PRAGMA 优化：mmap_size=256MB、cache_size=64MB、foreign_keys=ON

### 9.2 进程管理

- ProcessManager：fork、信号处理、PID 文件
- HealthMonitor：端口可用性、HTTP 健康检查
- GracefulShutdown：SIGTERM/SIGINT 处理
- Windows 特定：spawn 冷却期（#921 修复）
- 孤儿进程清理器：5 分钟扫描周期

### 9.3 跨平台支持

| 平台 | 支持状态 | 特殊处理 |
|------|---------|---------|
| macOS | ✅ 完整支持 | 无 |
| Linux | ✅ 完整支持 | 无 |
| Windows | ✅ 支持 | Chroma 禁用（MCP SDK 控制台弹窗）、.exe 后缀检测、shell: true |

### 9.4 安装系统

```
setup.sh (Linux/Mac)：
  Bash 脚本，set -euo pipefail
  检测 Bun/uv 常见安装路径（~/.bun, /opt/homebrew 等）
  版本跟踪 marker 文件（.install-version）

smart-install.js (跨平台)：
  Node.js 脚本，Windows 和 Unix 路径处理
  Bun 最小版本：1.1.14+ (需要 .changes 属性)
  自动安装 Bun（https://bun.sh/install）
  自动安装 uv（可选，用于 Python/Chroma）
```

---

## 十、关键文件和代码规模

| 文件 | 行数 | 用途 |
|------|------|------|
| worker-service.ts | ~1000 | 主编排器 |
| SessionStore.ts | ~2000 | 核心 CRUD |
| SearchManager.ts | ~1500 | 搜索管理 |
| ChromaSync.ts | ~1000 | 向量同步 |
| SessionSearch.ts | ~600 | 查询构建 |
| SDKAgent.ts | ~600 | Agent 实现 |
| migrations.ts | ~500 | 迁移系统 |
| viewer.html | ~2875 | UI 模板（含 CSS） |

---

## 十一、关键设计决策

| 决策 | 原因 | 影响 |
|------|------|------|
| memorySessionId 延迟初始化 | SDK 必须先响应才能捕获 | 防止 FK 约束碰撞 |
| Windows 禁用 Chroma | MCP SDK 产生控制台弹出 | 降级为 SQLite 搜索 |
| 边缘标签剥离 | 防止污染数据库 | 一层防御隐私 |
| 孤儿进程清理器 | SDK 生成 zombie 进程 | 后台 5 分钟扫描 |
| 后台初始化 | 快速钩子响应 | 30 秒超时保护 |
| Agent 抽象 | 多个 AI 提供者支持 | 优雅回退机制 |
| Bun 运行时 | SQLite 原生绑定、启动速度快 | 额外依赖安装 |
| SQLite 而非 PostgreSQL | 零配置、本地优先 | 不支持并发写入 |
| ESBuild 而非 Webpack | 毫秒级编译速度 | 更少插件生态 |
| 向量文档分离策略 | 短文本嵌入更精确 | 文档数量倍增 |
| Hook exit(0) 策略 | 不阻塞 Claude Code | Windows 终端标签不累积 |
| 两阶段 Worker 启动 | Hook 响应 < 500ms | 后台任务可能延迟 |

---

## 十二、性能优化分析

### 12.1 Token 经济学

| 操作 | Token 成本 | 优化方式 |
|------|----------|---------|
| 搜索索引 | 50-100/结果 | 批量过滤前检索 |
| 完整观察 | 500-1000/条 | 仅获取相关 IDs |
| 时间线 | 200-300 | 10x 节省的关键 |
| 批量获取 | N×tokens | 1 次请求 vs N 次 |

### 12.2 UI 性能

| 优化策略 | 说明 |
|---------|------|
| SSE 增量更新 | 避免轮询 |
| IntersectionObserver | 懒加载（无限滚动） |
| React.memo | 防止不必要重渲染 |
| useMemo | 缓存数据合并和排序 |
| IIFE Bundle | 减少 HTTP 请求 |

### 12.3 数据库性能

| 优化策略 | 说明 |
|---------|------|
| WAL 模式 | 并发读写 |
| mmap 256MB | 内存映射加速读取 |
| cache 64MB | 减少磁盘 I/O |
| 索引覆盖 | 高频查询字段均有索引 |

---

## 十三、文档系统分析

```
Mintlify 文档系统 (docs/public/)：

docs.json 配置：
  Primary 色：#3B82F6 (Blue)
  主题：mint
  10+ 导航组，40+ 文档页

页面分类：
  Get Started          → 5 个入门指南
  Cursor Integration   → 3 个 Cursor 设置页
  Best Practices       → Context Engineering 等
  Configuration        → 5 个配置/开发页
  Architecture         → 8 个深层架构文档

资源：
  Logo: Light/Dark 版本 (webp 格式)
  预览 GIF: cm-preview.gif (2MB)
  SVG 图标
```

---

## 十四、总结评估

Claude-Mem 是一个**精心设计的生产级 Node.js/TypeScript 应用**，展现了以下工程特质：

| 维度 | 评估 | 说明 |
|------|------|------|
| **架构设计** | ✅ 优秀 | 清晰的分层架构、策略模式、编排器模式、适配器模式 |
| **代码组织** | ✅ 优秀 | 高度模块化、职责清晰、目录结构合理 |
| **数据层** | ✅ 优秀 | 版本化迁移、WAL 优化、事务保护 |
| **搜索系统** | ✅ 优秀 | 三层工作流、策略模式、Token 经济优化 |
| **UI** | ✅ 良好 | 响应式 React、完整主题系统、SSE 实时更新 |
| **错误处理** | ✅ 优秀 | 分级 exit codes、消息队列重试、优雅关闭 |
| **跨平台** | ✅ 良好 | Windows/Mac/Linux 支持，有 Windows 特定限制 |
| **隐私控制** | ✅ 优秀 | 边缘标签剥离、ReDoS 防护、全本地存储 |
| **可扩展性** | ✅ 优秀 | 多 Agent 回退、策略模式、IDE 适配器 |
| **测试覆盖** | ✅ 良好 | 单元测试 + 集成测试，覆盖核心模块 |
